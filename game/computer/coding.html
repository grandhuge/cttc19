<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Code Adventure - ‡πÄ‡∏Å‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Kanit', sans-serif;
            overflow-x: hidden;
        }
        
        .robot {
            transition: all 0.5s ease-in-out;
            font-size: clamp(1.5rem, 4vw, 2rem);
        }
        
        .grid-cell {
            transition: background-color 0.3s ease;
            aspect-ratio: 1;
            min-height: 40px;
        }
        
        .code-block {
            cursor: grab;
            transition: all 0.2s ease;
            touch-action: none;
            user-select: none;
        }
        
        .code-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .code-block:active {
            cursor: grabbing;
            transform: scale(0.95);
        }
        
        .drop-zone {
            min-height: 60px;
            border: 2px dashed #cbd5e1;
            transition: all 0.2s ease;
        }
        
        .drop-zone.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .star {
            animation: twinkle 1s ease-in-out infinite alternate;
        }
        
        @keyframes twinkle {
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.1); }
        }
        
        .bounce {
            animation: bounce 0.5s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes floatUp {
            0% { 
                opacity: 1; 
                transform: translateY(0); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-30px); 
            }
        }
        
        .combo-glow {
            box-shadow: 0 0 20px rgba(255, 165, 0, 0.6);
            animation: glow 1s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(255, 165, 0, 0.6); }
            to { box-shadow: 0 0 30px rgba(255, 165, 0, 0.8); }
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .grid-cell {
                min-height: 35px;
                font-size: 1.2rem;
            }
            
            .code-block {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
            
            .mobile-scroll {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-grid {
                min-width: 300px;
            }
        }
        
        @media (max-width: 480px) {
            .grid-cell {
                min-height: 30px;
                font-size: 1rem;
            }
            
            .code-block {
                font-size: 0.7rem;
                padding: 0.4rem;
            }
        }
        
        /* Touch-friendly interactions */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Landscape mobile adjustments */
        @media (max-height: 500px) and (orientation: landscape) {
            .header-compact {
                padding: 0.5rem 0;
            }
            
            .content-compact {
                padding: 0.5rem;
            }
        }
        
        /* Tablet optimizations */
        @media (min-width: 768px) and (max-width: 1024px) {
            .tablet-layout {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .grid-cell {
                border-width: 1px;
            }
        }
        
        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            .robot, .bounce, .pulse, .star, .combo-glow {
                animation: none;
            }
            
            .code-block {
                transition: none;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .dark-mode-bg {
                background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            }
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-400 via-pink-300 to-blue-400 min-h-screen">
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-sm shadow-lg header-compact">
        <div class="container mx-auto px-2 sm:px-4 py-2 sm:py-4">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <div class="text-2xl sm:text-3xl">ü§ñ</div>
                    <h1 class="text-lg sm:text-2xl font-bold text-gray-800 hidden sm:block">Robot Code Adventure</h1>
                    <h1 class="text-lg font-bold text-gray-800 sm:hidden">Robot Code</h1>
                </div>
                
                <!-- Desktop Stats -->
                <div class="hidden lg:flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-blue-500 text-xl">üèÜ</span>
                        <span id="score" class="font-semibold text-gray-700">0</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-yellow-500 text-xl">‚≠ê</span>
                        <span id="stars" class="font-semibold text-gray-700">0</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-purple-500 text-xl">üíé</span>
                        <span id="gems" class="font-semibold text-gray-700">0</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-green-500 text-xl">‚ö°</span>
                        <div class="w-16 bg-gray-200 rounded-full h-2">
                            <div id="energyBar" class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600">‡∏î‡πà‡∏≤‡∏ô <span id="level">1</span>/8</div>
                    <div class="text-sm text-gray-600">‚è±Ô∏è <span id="timer">--</span>s</div>
                </div>
                
                <!-- Mobile Stats -->
                <div class="flex lg:hidden items-center space-x-2 text-sm">
                    <div class="flex items-center space-x-1">
                        <span class="text-blue-500">üèÜ</span>
                        <span id="scoreMobile" class="font-semibold text-gray-700">0</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span class="text-yellow-500">‚≠ê</span>
                        <span id="starsMobile" class="font-semibold text-gray-700">0</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span class="text-purple-500">üíé</span>
                        <span id="gemsMobile" class="font-semibold text-gray-700">0</span>
                    </div>
                    <div class="text-gray-600"><span id="levelMobile">1</span>/8</div>
                    <div class="text-gray-600">‚è±Ô∏è<span id="timerMobile">--</span>s</div>
                </div>
            </div>
            
            <!-- Mobile Energy Bar -->
            <div class="lg:hidden mt-2">
                <div class="flex items-center space-x-2">
                    <span class="text-green-500 text-sm">‚ö°</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div id="energyBarMobile" class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="container mx-auto px-4 py-8 text-center">
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-8 max-w-2xl mx-auto">
            <div class="text-6xl mb-6">ü§ñ‚ú®</div>
            <h1 class="text-4xl font-bold text-gray-800 mb-4">Robot Code Adventure</h1>
            <h2 class="text-2xl text-purple-600 mb-6">‡πÄ‡∏Å‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å</h2>
            
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üéØ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</h3>
                <div class="grid md:grid-cols-2 gap-4 text-left">
                    <div class="space-y-3">
                        <div class="flex items-start space-x-3">
                            <span class="text-2xl">1Ô∏è‚É£</span>
                            <div>
                                <h4 class="font-semibold text-gray-700">‡∏•‡∏≤‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</h4>
                                <p class="text-sm text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏Å‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡πâ‡∏î</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <span class="text-2xl">2Ô∏è‚É£</span>
                            <div>
                                <h4 class="font-semibold text-gray-700">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</h4>
                                <p class="text-sm text-gray-600">‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏î‡∏≤‡∏ß</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-start space-x-3">
                            <span class="text-2xl">3Ô∏è‚É£</span>
                            <div>
                                <h4 class="font-semibold text-gray-700">‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î</h4>
                                <p class="text-sm text-gray-600">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <span class="text-2xl">4Ô∏è‚É£</span>
                            <div>
                                <h4 class="font-semibold text-gray-700">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</h4>
                                <p class="text-sm text-gray-600">‡πÄ‡∏Å‡πá‡∏ö‡∏î‡∏≤‡∏ß ‚≠ê ‡πÄ‡∏û‡∏ä‡∏£ üíé ‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô ‚ö° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-8">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö</h3>
                <div class="text-sm text-yellow-700 space-y-1">
                    <p>‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏ö‡∏•‡πá‡∏≠‡∏Å "‡∏ó‡∏≥‡∏ã‡πâ‡∏≥" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</p>
                    <p>‚Ä¢ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏û‡∏ä‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏ö‡∏ô‡∏±‡∏™</p>
                    <p>‚Ä¢ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏ö‡∏ô‡∏±‡∏™</p>
                    <p>‚Ä¢ ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ üß± ‡πÅ‡∏•‡∏∞‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô ‚ö°</p>
                </div>
            </div>
            
            <button id="startGameBtn" class="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white text-xl font-bold px-8 py-4 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-200">
                üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
            </button>
        </div>
    </div>

    <!-- Game Content -->
    <div id="gameContent" class="container mx-auto px-2 sm:px-4 py-3 sm:py-6 content-compact hidden">
        <div class="grid grid-cols-1 xl:grid-cols-3 lg:grid-cols-2 gap-3 sm:gap-6 tablet-layout">
            <!-- Game Board -->
            <div class="xl:col-span-2 lg:col-span-1 order-1">
                <div class="bg-white/95 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-xl p-3 sm:p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-3 sm:mb-4 gap-2">
                        <h2 class="text-lg sm:text-xl font-semibold text-gray-800">üéØ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡∏ä‡πà‡∏ß‡∏¢‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÄ‡∏Å‡πá‡∏ö‡∏î‡∏≤‡∏ß!</h2>
                        <div class="flex space-x-2">
                            <button id="runBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors touch-target text-sm sm:text-base">
                                ‚ñ∂Ô∏è ‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î
                            </button>
                            <button id="resetBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors touch-target text-sm sm:text-base">
                                üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                            </button>
                        </div>
                    </div>
                    
                    <!-- Game Grid Container with horizontal scroll on mobile -->
                    <div class="mobile-scroll mb-3 sm:mb-4">
                        <div id="gameGrid" class="grid grid-cols-5 gap-1 sm:gap-2 max-w-xs sm:max-w-md mx-auto mobile-grid">
                            <!-- Grid cells will be generated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Level Info -->
                    <div id="levelInfo" class="bg-blue-50 border-l-4 border-blue-400 p-3 sm:p-4 rounded-r-lg">
                        <h3 class="font-semibold text-blue-800 mb-2 text-sm sm:text-base">üìö ‡∏î‡πà‡∏≤‡∏ô 1: ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</h3>
                        <p class="text-blue-700 text-sm sm:text-base">‡∏•‡∏≤‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏î‡∏≤‡∏ß!</p>
                    </div>
                </div>
            </div>

            <!-- Coding Panel -->
            <div class="space-y-3 sm:space-y-6 order-2 lg:order-2">
                <!-- Available Blocks -->
                <div class="bg-white/95 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-xl p-3 sm:p-6">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">üß© ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</h3>
                    <div id="blockPalette" class="space-y-2 sm:space-y-3">
                        <!-- Code blocks will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Code Area -->
                <div class="bg-white/95 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-xl p-3 sm:p-6">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">üìù ‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                    <div id="codeArea" class="drop-zone rounded-lg p-3 sm:p-4 space-y-2 min-h-[120px] sm:min-h-[160px]">
                        <div class="text-gray-400 text-center py-4 sm:py-8 text-sm sm:text-base">‡∏•‡∏≤‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
                    </div>
                </div>

                <!-- Progress & Stats -->
                <div class="bg-white/95 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-xl p-3 sm:p-6">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ & ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤</h3>
                    <div class="space-y-2 sm:space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-xs sm:text-sm text-gray-600">‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô</span>
                            <span id="completedLevels" class="font-semibold text-green-600 text-sm sm:text-base">0/8</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 sm:gap-4">
                            <div class="flex items-center justify-between">
                                <span class="text-xs sm:text-sm text-gray-600">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</span>
                                <span id="combo" class="font-semibold text-orange-600 text-sm sm:text-base">0x</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-xs sm:text-sm text-gray-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°</span>
                                <span id="attempts" class="font-semibold text-blue-600 text-sm sm:text-base">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Achievements -->
                <div class="bg-white/95 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-xl p-3 sm:p-6">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">üèÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
                    <div id="achievements" class="space-y-2 max-h-32 sm:max-h-48 overflow-y-auto">
                        <div class="text-gray-400 text-center text-xs sm:text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-8 max-w-sm sm:max-w-md w-full mx-auto text-center transform scale-95 transition-transform">
            <div class="text-4xl sm:text-6xl mb-3 sm:mb-4">üéâ</div>
            <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</h3>
            <p id="successMessage" class="text-gray-600 mb-4 sm:mb-6 text-sm sm:text-base">‡∏Ñ‡∏∏‡∏ì‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</p>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 justify-center">
                <button id="nextLevelBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 sm:px-6 py-2 rounded-lg font-medium transition-colors touch-target text-sm sm:text-base">
                    ‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                </button>
                <button id="replayBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 sm:px-6 py-2 rounded-lg font-medium transition-colors touch-target text-sm sm:text-base">
                    ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm">¬© developed by Tle Narongphisit | CTTC19 @ CPD</p>
        </div>
    </footer>

    <script>
        class RobotCodeGame {
            constructor() {
                this.currentLevel = 1;
                this.totalStars = 0;
                this.completedLevels = 0;
                this.robotPosition = { x: 0, y: 0 };
                this.robotDirection = 'right'; // right, left, up, down
                this.codeBlocks = [];
                this.isRunning = false;
                
                // Scoring system
                this.score = 0;
                this.attempts = 0;
                this.timeStarted = null;
                this.levelStartTime = null;
                this.bestTimes = {};
                this.achievements = [];
                this.combo = 0;
                this.maxCombo = 0;
                this.levelScores = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏î‡πà‡∏≤‡∏ô
                this.totalLevels = 8; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                
                // Game mechanics
                this.gems = [];
                this.obstacles = [];
                this.powerUps = [];
                this.energy = 100;
                this.maxEnergy = 100;
                
                this.levels = {
                    1: {
                        title: "‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á",
                        description: "‡∏•‡∏≤‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î \"‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î\" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏î‡∏≤‡∏ß!",
                        grid: [
                            ['ü§ñ', '‚¨ú', 'üíé', '‚≠ê', '‚ö°'],
                            ['‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú'],
                            ['‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú'],
                            ['‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú'],
                            ['‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú']
                        ],
                        availableBlocks: ['forward', 'forward', 'forward', 'forward'],
                        stars: [{ x: 3, y: 0 }],
                        gems: [{ x: 2, y: 0 }],
                        powerUps: [{ x: 4, y: 0 }],
                        timeLimit: 30,
                        optimalMoves: 4,
                        maxScore: 1000
                    },
                    2: {
                        title: "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏•‡∏π‡∏õ (Loop)",
                        description: "‡πÉ‡∏ä‡πâ‡∏ö‡∏•‡πá‡∏≠‡∏Å \"‡∏ó‡∏≥‡∏ã‡πâ‡∏≥\" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô! ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏ö‡∏ô‡∏±‡∏™!",
                        grid: [
                            ['ü§ñ', 'üíé', '‚¨ú', 'üíé', '‚≠ê'],
                            ['‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú', 'üíé'],
                            ['‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú'],
                            ['‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú'],
                            ['‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú', '‚¨ú']
                        ],
                        availableBlocks: ['repeat', 'forward', 'turnRight'],
                        stars: [{ x: 4, y: 0 }],
                        gems: [{ x: 1, y: 0 }, { x: 3, y: 0 }, { x: 4, y: 1 }],
                        timeLimit: 45,
                        optimalMoves: 3,
                        maxScore: 1500
                    },
                    3: {
                        title: "‡πÄ‡∏Ç‡∏≤‡∏ß‡∏á‡∏Å‡∏ï‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢",
                        description: "‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏û‡∏ä‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏î‡∏≤‡∏ß! ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢!",
                        grid: [
                            ['ü§ñ', '‚¨ú', 'üß±', 'üíé', '‚¨ú'],
                            ['üíé', '‚¨ú', 'üß±', '‚¨ú', 'üíé'],
                            ['‚¨ú', '‚¨ú', '‚¨ú', 'üß±', '‚¨ú'],
                            ['üß±', 'üíé', '‚¨ú', '‚¨ú', '‚≠ê'],
                            ['‚¨ú', '‚¨ú', 'üß±', '‚¨ú', '‚ö°']
                        ],
                        availableBlocks: ['forward', 'turnRight', 'turnLeft', 'repeat'],
                        stars: [{ x: 4, y: 3 }],
                        gems: [{ x: 3, y: 0 }, { x: 0, y: 1 }, { x: 4, y: 1 }, { x: 1, y: 3 }],
                        powerUps: [{ x: 4, y: 4 }],
                        obstacles: [{ x: 2, y: 0 }, { x: 2, y: 1 }, { x: 3, y: 2 }, { x: 0, y: 3 }, { x: 2, y: 4 }],
                        timeLimit: 60,
                        optimalMoves: 8,
                        maxScore: 2000
                    },
                    4: {
                        title: "‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß",
                        description: "‡∏î‡πà‡∏≤‡∏ô‡πÇ‡∏ö‡∏ô‡∏±‡∏™! ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏û‡∏ä‡∏£‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î!",
                        grid: [
                            ['ü§ñ', 'üíé', 'üíé', 'üíé', 'üíé'],
                            ['üíé', 'üß±', '‚¨ú', 'üß±', 'üíé'],
                            ['üíé', '‚¨ú', '‚≠ê', '‚¨ú', 'üíé'],
                            ['üíé', 'üß±', '‚¨ú', 'üß±', 'üíé'],
                            ['üíé', 'üíé', 'üíé', 'üíé', '‚ö°']
                        ],
                        availableBlocks: ['forward', 'turnRight', 'turnLeft', 'repeat'],
                        stars: [{ x: 2, y: 2 }],
                        gems: [
                            { x: 1, y: 0 }, { x: 2, y: 0 }, { x: 3, y: 0 }, { x: 4, y: 0 },
                            { x: 0, y: 1 }, { x: 4, y: 1 }, { x: 0, y: 2 }, { x: 4, y: 2 },
                            { x: 0, y: 3 }, { x: 4, y: 3 }, { x: 0, y: 4 }, { x: 1, y: 4 },
                            { x: 2, y: 4 }, { x: 3, y: 4 }
                        ],
                        powerUps: [{ x: 4, y: 4 }],
                        obstacles: [{ x: 1, y: 1 }, { x: 3, y: 1 }, { x: 1, y: 3 }, { x: 3, y: 3 }],
                        timeLimit: 90,
                        optimalMoves: 12,
                        maxScore: 3000
                    },
                    5: {
                        title: "‡πÄ‡∏Ç‡∏≤‡∏ß‡∏á‡∏Å‡∏ï‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô",
                        description: "‡πÄ‡∏Ç‡∏≤‡∏ß‡∏á‡∏Å‡∏ï‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô! ‡πÉ‡∏ä‡πâ‡∏•‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏≤‡∏ç‡∏â‡∏•‡∏≤‡∏î!",
                        grid: [
                            ['ü§ñ', 'üß±', 'üíé', 'üß±', '‚¨ú'],
                            ['‚¨ú', 'üß±', '‚¨ú', 'üß±', 'üíé'],
                            ['üíé', '‚¨ú', '‚¨ú', '‚¨ú', 'üß±'],
                            ['üß±', 'üß±', 'üíé', '‚¨ú', '‚≠ê'],
                            ['‚ö°', '‚¨ú', '‚¨ú', 'üß±', 'üíé']
                        ],
                        availableBlocks: ['forward', 'turnRight', 'turnLeft', 'repeat'],
                        stars: [{ x: 4, y: 3 }],
                        gems: [{ x: 2, y: 0 }, { x: 4, y: 1 }, { x: 0, y: 2 }, { x: 2, y: 3 }, { x: 4, y: 4 }],
                        powerUps: [{ x: 0, y: 4 }],
                        obstacles: [
                            { x: 1, y: 0 }, { x: 3, y: 0 }, { x: 1, y: 1 }, { x: 3, y: 1 }, 
                            { x: 4, y: 2 }, { x: 0, y: 3 }, { x: 1, y: 3 }, { x: 3, y: 4 }
                        ],
                        timeLimit: 75,
                        optimalMoves: 10,
                        maxScore: 2500
                    },
                    6: {
                        title: "‡∏î‡πà‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô",
                        description: "‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏µ! ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏û‡∏ä‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏î‡∏≤‡∏ß!",
                        grid: [
                            ['‚¨ú', 'üíé', 'üß±', 'üíé', '‚¨ú'],
                            ['ü§ñ', '‚¨ú', 'üß±', '‚¨ú', 'üíé'],
                            ['üß±', '‚¨ú', '‚¨ú', '‚¨ú', 'üß±'],
                            ['üíé', '‚¨ú', 'üß±', '‚¨ú', 'üíé'],
                            ['‚¨ú', 'üíé', '‚≠ê', 'üíé', '‚ö°']
                        ],
                        availableBlocks: ['forward', 'turnRight', 'turnLeft', 'repeat'],
                        stars: [{ x: 2, y: 4 }],
                        gems: [
                            { x: 1, y: 0 }, { x: 3, y: 0 }, { x: 4, y: 1 }, 
                            { x: 0, y: 3 }, { x: 4, y: 3 }, { x: 1, y: 4 }, { x: 3, y: 4 }
                        ],
                        powerUps: [{ x: 4, y: 4 }],
                        obstacles: [
                            { x: 2, y: 0 }, { x: 2, y: 1 }, { x: 0, y: 2 }, { x: 4, y: 2 }, { x: 2, y: 3 }
                        ],
                        robotStart: { x: 0, y: 1 }, // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                        timeLimit: 90,
                        optimalMoves: 15,
                        maxScore: 3500
                    },
                    7: {
                        title: "‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢",
                        description: "‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î! ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ!",
                        grid: [
                            ['ü§ñ', 'üß±', 'üíé', 'üß±', 'üíé'],
                            ['üíé', '‚¨ú', 'üß±', '‚¨ú', 'üß±'],
                            ['üß±', '‚¨ú', 'üíé', '‚¨ú', 'üíé'],
                            ['üíé', 'üß±', '‚¨ú', 'üß±', '‚¨ú'],
                            ['‚ö°', 'üíé', 'üß±', '‚≠ê', 'üíé']
                        ],
                        availableBlocks: ['forward', 'turnRight', 'turnLeft', 'repeat'],
                        stars: [{ x: 3, y: 4 }],
                        gems: [
                            { x: 2, y: 0 }, { x: 4, y: 0 }, { x: 0, y: 1 }, { x: 4, y: 2 }, 
                            { x: 2, y: 2 }, { x: 0, y: 3 }, { x: 1, y: 4 }, { x: 4, y: 4 }
                        ],
                        powerUps: [{ x: 0, y: 4 }],
                        obstacles: [
                            { x: 1, y: 0 }, { x: 3, y: 0 }, { x: 2, y: 1 }, { x: 4, y: 1 }, 
                            { x: 0, y: 2 }, { x: 1, y: 3 }, { x: 3, y: 3 }, { x: 2, y: 4 }
                        ],
                        timeLimit: 120,
                        optimalMoves: 18,
                        maxScore: 4000
                    },
                    8: {
                        title: "‡∏î‡πà‡∏≤‡∏ô‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©",
                        description: "‡∏î‡πà‡∏≤‡∏ô‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢! ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏û‡∏ä‡∏£‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î!",
                        grid: [
                            ['üíé', 'üíé', 'üß±', 'üíé', 'üíé'],
                            ['üíé', 'üß±', 'üíé', 'üß±', 'üíé'],
                            ['üß±', 'üíé', 'ü§ñ', 'üíé', 'üß±'],
                            ['üíé', 'üß±', 'üíé', 'üß±', 'üíé'],
                            ['üíé', 'üíé', '‚≠ê', 'üíé', '‚ö°']
                        ],
                        availableBlocks: ['forward', 'turnRight', 'turnLeft', 'repeat'],
                        stars: [{ x: 2, y: 4 }],
                        gems: [
                            { x: 0, y: 0 }, { x: 1, y: 0 }, { x: 3, y: 0 }, { x: 4, y: 0 },
                            { x: 0, y: 1 }, { x: 2, y: 1 }, { x: 4, y: 1 }, { x: 1, y: 2 }, { x: 3, y: 2 },
                            { x: 0, y: 3 }, { x: 2, y: 3 }, { x: 4, y: 3 }, { x: 0, y: 4 }, 
                            { x: 1, y: 4 }, { x: 3, y: 4 }
                        ],
                        powerUps: [{ x: 4, y: 4 }],
                        obstacles: [
                            { x: 2, y: 0 }, { x: 1, y: 1 }, { x: 3, y: 1 }, { x: 0, y: 2 }, 
                            { x: 4, y: 2 }, { x: 1, y: 3 }, { x: 3, y: 3 }
                        ],
                        timeLimit: 150,
                        optimalMoves: 20,
                        maxScore: 5000
                    }
                };
                
                this.blockTypes = {
                    forward: { 
                        label: '‚¨ÜÔ∏è ‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤', 
                        color: 'bg-blue-500', 
                        action: () => this.moveForward() 
                    },
                    turnLeft: { 
                        label: '‚¨ÖÔ∏è ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢', 
                        color: 'bg-yellow-500', 
                        action: () => this.turnLeft() 
                    },
                    turnRight: { 
                        label: '‚û°Ô∏è ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤', 
                        color: 'bg-orange-500', 
                        action: () => this.turnRight() 
                    },
                    repeat: { 
                        label: 'üîÑ ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 
                        color: 'bg-purple-500', 
                        action: async (times, childBlocks) => await this.repeat(times || 2, childBlocks) 
                    }
                };
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                // Don't load level immediately - wait for start button
                this.updateUI();
            }
            
            setupEventListeners() {
                document.getElementById('startGameBtn').addEventListener('click', () => this.startGame());
                document.getElementById('runBtn').addEventListener('click', () => this.runCode());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetLevel());
                document.getElementById('nextLevelBtn').addEventListener('click', () => this.nextLevel());
                document.getElementById('replayBtn').addEventListener('click', () => this.hideSuccessModal());
                
                // Setup drag and drop
                this.setupDragAndDrop();
            }
            
            startGame() {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('gameContent').classList.remove('hidden');
                this.loadLevel(1);
            }
            
            setupDragAndDrop() {
                const codeArea = document.getElementById('codeArea');
                
                // Traditional drag and drop for desktop
                codeArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    codeArea.classList.add('drag-over');
                });
                
                codeArea.addEventListener('dragleave', () => {
                    codeArea.classList.remove('drag-over');
                });
                
                codeArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    codeArea.classList.remove('drag-over');
                    
                    const blockType = e.dataTransfer.getData('text/plain');
                    this.addCodeBlock(blockType);
                });
                
                // Touch support for mobile devices
                this.setupTouchSupport();
            }
            
            setupTouchSupport() {
                let draggedElement = null;
                let touchOffset = { x: 0, y: 0 };
                
                document.addEventListener('touchstart', (e) => {
                    const target = e.target.closest('.code-block');
                    if (target && target.draggable) {
                        draggedElement = target;
                        const touch = e.touches[0];
                        const rect = target.getBoundingClientRect();
                        touchOffset.x = touch.clientX - rect.left;
                        touchOffset.y = touch.clientY - rect.top;
                        
                        // Visual feedback
                        target.style.opacity = '0.7';
                        target.style.transform = 'scale(1.05)';
                        
                        e.preventDefault();
                    }
                }, { passive: false });
                
                document.addEventListener('touchmove', (e) => {
                    if (draggedElement) {
                        const touch = e.touches[0];
                        
                        // Create or update ghost element
                        let ghost = document.getElementById('touch-ghost');
                        if (!ghost) {
                            ghost = draggedElement.cloneNode(true);
                            ghost.id = 'touch-ghost';
                            ghost.style.position = 'fixed';
                            ghost.style.pointerEvents = 'none';
                            ghost.style.zIndex = '1000';
                            ghost.style.opacity = '0.8';
                            ghost.style.transform = 'scale(0.9)';
                            document.body.appendChild(ghost);
                        }
                        
                        ghost.style.left = (touch.clientX - touchOffset.x) + 'px';
                        ghost.style.top = (touch.clientY - touchOffset.y) + 'px';
                        
                        // Check if over drop zone
                        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                        const dropZone = elementBelow?.closest('#codeArea');
                        
                        if (dropZone) {
                            dropZone.classList.add('drag-over');
                        } else {
                            document.getElementById('codeArea').classList.remove('drag-over');
                        }
                        
                        e.preventDefault();
                    }
                }, { passive: false });
                
                document.addEventListener('touchend', (e) => {
                    if (draggedElement) {
                        const touch = e.changedTouches[0];
                        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                        const dropZone = elementBelow?.closest('#codeArea');
                        
                        if (dropZone) {
                            const blockType = draggedElement.textContent.includes('‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤') ? 'forward' :
                                            draggedElement.textContent.includes('‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢') ? 'turnLeft' :
                                            draggedElement.textContent.includes('‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤') ? 'turnRight' :
                                            draggedElement.textContent.includes('‡∏ó‡∏≥‡∏ã‡πâ‡∏≥') ? 'repeat' : null;
                            
                            if (blockType) {
                                this.addCodeBlock(blockType);
                            }
                        }
                        
                        // Cleanup
                        draggedElement.style.opacity = '';
                        draggedElement.style.transform = '';
                        document.getElementById('codeArea').classList.remove('drag-over');
                        
                        const ghost = document.getElementById('touch-ghost');
                        if (ghost) {
                            ghost.remove();
                        }
                        
                        draggedElement = null;
                    }
                });
            }
            
            loadLevel(levelNum) {
                const level = this.levels[levelNum];
                if (!level) return;
                
                this.currentLevel = levelNum;
                
                // ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏î‡πà‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (0,0)
                const startPos = level.robotStart || { x: 0, y: 0 };
                this.robotPosition = { ...startPos };
                this.robotDirection = 'right';
                this.attempts = 0;
                this.energy = this.maxEnergy;
                this.levelStartTime = Date.now();
                this.gems = [...(level.gems || [])];
                this.powerUps = [...(level.powerUps || [])];
                this.obstacles = [...(level.obstacles || [])];
                
                // Store initial level state for resets
                this.initialLevelState = {
                    gems: [...(level.gems || [])],
                    powerUps: [...(level.powerUps || [])],
                    robotPosition: { ...startPos },
                    robotDirection: 'right'
                };
                
                // Start timer
                this.startTimer(level.timeLimit);
                
                // Update level info
                document.getElementById('levelInfo').innerHTML = `
                    <h3 class="font-semibold text-blue-800 mb-2">üìö ‡∏î‡πà‡∏≤‡∏ô ${levelNum}: ${level.title}</h3>
                    <p class="text-blue-700">${level.description}</p>
                    <div class="mt-2 flex items-center space-x-4 text-sm">
                        <span class="text-green-600">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤: ${level.timeLimit}s</span>
                        <span class="text-purple-600">üéØ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°: ${level.optimalMoves}</span>
                        <span class="text-blue-600">üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${level.maxScore}</span>
                    </div>
                `;
                
                // Generate grid
                this.generateGrid(level.grid);
                
                // Generate available blocks
                this.generateBlockPalette(level.availableBlocks);
                
                // Clear code area
                this.clearCodeArea();
                
                this.updateUI();
            }
            
            resetRobotPosition() {
                if (!this.initialLevelState) return;
                
                // Remove robot from current position
                const currentCell = document.querySelector(`[data-x="${this.robotPosition.x}"][data-y="${this.robotPosition.y}"]`);
                if (currentCell) {
                    // Check if there should be collectibles at this position
                    const level = this.levels[this.currentLevel];
                    const hasGem = level.gems?.some(gem => gem.x === this.robotPosition.x && gem.y === this.robotPosition.y);
                    const hasPowerUp = level.powerUps?.some(p => p.x === this.robotPosition.x && p.y === this.robotPosition.y);
                    const hasStar = level.stars?.some(star => star.x === this.robotPosition.x && star.y === this.robotPosition.y);
                    
                    let cellContent = '';
                    if (hasGem && !this.isGemCollected({x: this.robotPosition.x, y: this.robotPosition.y})) cellContent += 'üíé';
                    if (hasPowerUp && this.powerUps.some(p => p.x === this.robotPosition.x && p.y === this.robotPosition.y)) cellContent += '‚ö°';
                    if (hasStar) cellContent += '<div class="star">‚≠ê</div>';
                    
                    currentCell.innerHTML = cellContent;
                }
                
                // Reset robot to starting position
                this.robotPosition = { ...this.initialLevelState.robotPosition };
                this.robotDirection = this.initialLevelState.robotDirection;
                
                // Place robot at starting position
                const startCell = document.querySelector(`[data-x="${this.robotPosition.x}"][data-y="${this.robotPosition.y}"]`);
                if (startCell) {
                    const directions = {
                        'right': 'ü§ñ‚û°Ô∏è',
                        'left': '‚¨ÖÔ∏èü§ñ',
                        'up': '‚¨ÜÔ∏èü§ñ',
                        'down': '‚¨áÔ∏èü§ñ'
                    };
                    startCell.innerHTML = `<div class="robot">${directions[this.robotDirection]}</div>`;
                }
            }
            
            generateGrid(gridData) {
                const gameGrid = document.getElementById('gameGrid');
                gameGrid.innerHTML = '';
                
                // Detect device type for appropriate sizing
                const isMobile = window.innerWidth < 768;
                const cellSize = isMobile ? 'w-12 h-12' : 'w-16 h-16';
                const textSize = isMobile ? 'text-lg' : 'text-2xl';
                
                for (let y = 0; y < gridData.length; y++) {
                    for (let x = 0; x < gridData[y].length; x++) {
                        const cell = document.createElement('div');
                        cell.className = `grid-cell ${cellSize} border-2 border-gray-300 rounded-lg flex items-center justify-center ${textSize} bg-white`;
                        cell.dataset.x = x;
                        cell.dataset.y = y;
                        
                        const content = gridData[y][x];
                        
                        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        if (content === 'ü§ñ') {
                            // ‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢ loadLevel()
                            cell.innerHTML = '<div class="robot">ü§ñ‚û°Ô∏è</div>';
                        } else if (content === '‚≠ê') {
                            cell.innerHTML = '<div class="star">‚≠ê</div>';
                        } else if (content === 'üß±') {
                            cell.innerHTML = 'üß±';
                            cell.classList.add('bg-gray-400');
                        } else if (content === 'üíé') {
                            cell.innerHTML = 'üíé';
                        } else if (content === '‚ö°') {
                            cell.innerHTML = '‚ö°';
                        }
                        
                        gameGrid.appendChild(cell);
                    }
                }
                
                // ‡∏ß‡∏≤‡∏á‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                this.placeRobotAtCorrectPosition();
            }
            
            placeRobotAtCorrectPosition() {
                // ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                const allCells = document.querySelectorAll('.grid-cell');
                allCells.forEach(cell => {
                    if (cell.innerHTML.includes('ü§ñ')) {
                        // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå
                        const level = this.levels[this.currentLevel];
                        const x = parseInt(cell.dataset.x);
                        const y = parseInt(cell.dataset.y);
                        
                        let cellContent = '';
                        
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        if (level.gems?.some(gem => gem.x === x && gem.y === y)) cellContent += 'üíé';
                        if (level.powerUps?.some(p => p.x === x && p.y === y)) cellContent += '‚ö°';
                        if (level.stars?.some(star => star.x === x && star.y === y)) cellContent += '<div class="star">‚≠ê</div>';
                        if (level.grid[y][x] === 'üß±') {
                            cellContent = 'üß±';
                            cell.classList.add('bg-gray-400');
                        }
                        
                        cell.innerHTML = cellContent;
                    }
                });
                
                // ‡∏ß‡∏≤‡∏á‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                const robotCell = document.querySelector(`[data-x="${this.robotPosition.x}"][data-y="${this.robotPosition.y}"]`);
                if (robotCell) {
                    const directions = {
                        'right': 'ü§ñ‚û°Ô∏è',
                        'left': '‚¨ÖÔ∏èü§ñ',
                        'up': '‚¨ÜÔ∏èü§ñ',
                        'down': '‚¨áÔ∏èü§ñ'
                    };
                    
                    // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏•‡∏•‡πå
                    const existingContent = robotCell.innerHTML;
                    robotCell.innerHTML = `<div class="robot">${directions[this.robotDirection]}</div>` + 
                                         (existingContent && !existingContent.includes('ü§ñ') ? existingContent : '');
                }
            }
            
            generateBlockPalette(availableBlocks) {
                const palette = document.getElementById('blockPalette');
                palette.innerHTML = '';
                
                const uniqueBlocks = [...new Set(availableBlocks)];
                
                uniqueBlocks.forEach(blockType => {
                    const block = this.blockTypes[blockType];
                    if (!block) return;
                    
                    const blockElement = document.createElement('div');
                    blockElement.className = `code-block ${block.color} text-white px-4 py-3 rounded-lg font-medium text-sm`;
                    blockElement.draggable = true;
                    blockElement.textContent = block.label;
                    
                    blockElement.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', blockType);
                    });
                    
                    palette.appendChild(blockElement);
                });
            }
            
            addCodeBlock(blockType) {
                const block = this.blockTypes[blockType];
                if (!block) return;
                
                const codeArea = document.getElementById('codeArea');
                if (codeArea.children.length === 1 && codeArea.children[0].textContent.includes('‡∏•‡∏≤‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å')) {
                    codeArea.innerHTML = '';
                }
                
                const blockElement = document.createElement('div');
                blockElement.className = `${block.color} text-white px-4 py-3 rounded-lg font-medium text-sm flex items-center justify-between`;
                blockElement.dataset.blockType = blockType;
                blockElement.innerHTML = `
                    <span>${block.label}</span>
                    <button class="ml-2 text-white hover:text-red-200 remove-btn">‚ùå</button>
                `;
                
                // Add event listener for remove button
                const removeBtn = blockElement.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => {
                    blockElement.remove();
                });
                
                codeArea.appendChild(blockElement);
            }
            
            removeCodeBlock(blockElement) {
                blockElement.remove();
            }
            
            getCurrentCodeBlocks() {
                const codeArea = document.getElementById('codeArea');
                const blocks = [];
                
                Array.from(codeArea.children).forEach(child => {
                    if (child.dataset.blockType) {
                        blocks.push(child.dataset.blockType);
                    }
                });
                
                return blocks;
            }
            
            clearCodeArea() {
                const codeArea = document.getElementById('codeArea');
                codeArea.innerHTML = '<div class="text-gray-400 text-center py-8">‡∏•‡∏≤‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>';
            }
            
            startTimer(timeLimit) {
                this.timeRemaining = timeLimit;
                this.timerInterval = setInterval(() => {
                    this.timeRemaining--;
                    document.getElementById('timer').textContent = this.timeRemaining;
                    
                    if (this.timeRemaining <= 0) {
                        clearInterval(this.timerInterval);
                        this.gameOver('‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î! ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    }
                }, 1000);
            }
            
            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
            }
            
            calculateScore() {
                const level = this.levels[this.currentLevel];
                const currentBlocks = this.getCurrentCodeBlocks();
                const timeBonus = Math.max(0, this.timeRemaining * 10);
                const moveEfficiency = Math.max(0, (level.optimalMoves - currentBlocks.length + level.optimalMoves) * 50);
                const gemBonus = this.gems.filter(gem => !this.isGemCollected(gem)).length === 0 ? 500 : 0;
                const comboBonus = this.combo * 100;
                const attemptPenalty = Math.max(0, (this.attempts - 1) * 50);
                
                return Math.max(0, timeBonus + moveEfficiency + gemBonus + comboBonus - attemptPenalty);
            }
            
            async runCode() {
                // Get current code blocks from the UI
                const currentBlocks = this.getCurrentCodeBlocks();
                
                if (this.isRunning || currentBlocks.length === 0) return;
                
                this.attempts++;
                this.isRunning = true;
                document.getElementById('runBtn').disabled = true;
                document.getElementById('runBtn').textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô...';
                
                // Reset robot to starting position before running
                this.resetRobotPosition();
                
                // Consume energy
                this.energy = Math.max(0, this.energy - 10);
                
                try {
                    await this.executeBlocks(currentBlocks);
                    this.checkWinCondition();
                } catch (error) {
                    console.error('Error running code:', error);
                    this.combo = 0; // Reset combo on error
                }
                
                this.isRunning = false;
                document.getElementById('runBtn').disabled = false;
                document.getElementById('runBtn').textContent = '‚ñ∂Ô∏è ‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î';
                this.updateUI();
            }
            
            async executeBlocks(blocks) {
                for (let i = 0; i < blocks.length; i++) {
                    const blockType = blocks[i];
                    const block = this.blockTypes[blockType];
                    
                    if (block && block.action) {
                        if (blockType === 'repeat') {
                            // ‡∏´‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                            const previousCommand = i > 0 ? blocks[i - 1] : 'forward';
                            await block.action(2, [previousCommand]);
                        } else {
                            await new Promise(resolve => {
                                setTimeout(() => {
                                    block.action();
                                    resolve();
                                }, 500);
                            });
                        }
                    }
                }
            }
            
            moveForward() {
                const { x, y } = this.robotPosition;
                let newX = x, newY = y;
                
                switch (this.robotDirection) {
                    case 'right': newX = x + 1; break;
                    case 'left': newX = x - 1; break;
                    case 'up': newY = y - 1; break;
                    case 'down': newY = y + 1; break;
                }
                
                // Check bounds
                if (newX >= 0 && newX < 5 && newY >= 0 && newY < 5) {
                    // Check for obstacles using level data instead of DOM
                    const level = this.levels[this.currentLevel];
                    const isObstacle = level.obstacles?.some(obs => obs.x === newX && obs.y === newY) || 
                                      level.grid[newY][newX] === 'üß±';
                    
                    if (!isObstacle) {
                        this.updateRobotPosition(newX, newY);
                    } else {
                        console.log('Cannot move - obstacle detected at', newX, newY);
                    }
                } else {
                    console.log('Cannot move - out of bounds', newX, newY);
                }
            }
            
            turnLeft() {
                const directions = ['up', 'left', 'down', 'right'];
                const currentIndex = directions.indexOf(this.robotDirection);
                this.robotDirection = directions[(currentIndex + 1) % 4];
                this.updateRobotDirection();
            }
            
            turnRight() {
                const directions = ['up', 'right', 'down', 'left'];
                const currentIndex = directions.indexOf(this.robotDirection);
                this.robotDirection = directions[(currentIndex + 1) % 4];
                this.updateRobotDirection();
            }
            
            async repeat(times, childBlocks) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ childBlocks ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ 4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                const blocksToRepeat = childBlocks || ['forward'];
                
                for (let i = 0; i < times; i++) {
                    await this.executeBlocks(blocksToRepeat);
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            updateRobotPosition(newX, newY) {
                // Remove robot from old position
                const oldCell = document.querySelector(`[data-x="${this.robotPosition.x}"][data-y="${this.robotPosition.y}"]`);
                oldCell.innerHTML = '';
                
                // Add robot to new position
                const newCell = document.querySelector(`[data-x="${newX}"][data-y="${newY}"]`);
                
                // Check collectibles
                if (newCell.textContent.includes('‚≠ê')) {
                    this.collectStar(newX, newY);
                }
                if (newCell.textContent.includes('üíé')) {
                    this.collectGem(newX, newY);
                }
                if (newCell.textContent.includes('‚ö°')) {
                    this.collectPowerUp(newX, newY);
                }
                
                const directions = {
                    'right': 'ü§ñ‚û°Ô∏è',
                    'left': '‚¨ÖÔ∏èü§ñ',
                    'up': '‚¨ÜÔ∏èü§ñ',
                    'down': '‚¨áÔ∏èü§ñ'
                };
                newCell.innerHTML = `<div class="robot bounce">${directions[this.robotDirection]}</div>`;
                this.robotPosition = { x: newX, y: newY };
            }
            
            collectGem(x, y) {
                const gemIndex = this.gems.findIndex(gem => gem.x === x && gem.y === y);
                if (gemIndex !== -1) {
                    this.gems.splice(gemIndex, 1);
                    this.score += 100;
                    this.combo++;
                    this.maxCombo = Math.max(this.maxCombo, this.combo);
                    this.showFloatingScore('+100', x, y, 'text-purple-600');
                    this.checkAchievements();
                }
            }
            
            collectPowerUp(x, y) {
                const powerUpIndex = this.powerUps.findIndex(p => p.x === x && p.y === y);
                if (powerUpIndex !== -1) {
                    this.powerUps.splice(powerUpIndex, 1);
                    this.energy = Math.min(this.maxEnergy, this.energy + 30);
                    this.score += 200;
                    this.showFloatingScore('+200 ‚ö°', x, y, 'text-green-600');
                }
            }
            
            isGemCollected(gem) {
                return !this.gems.find(g => g.x === gem.x && g.y === gem.y);
            }
            
            showFloatingScore(text, x, y, className) {
                const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
                const floatingText = document.createElement('div');
                floatingText.className = `absolute ${className} font-bold text-sm pointer-events-none z-10`;
                floatingText.textContent = text;
                floatingText.style.animation = 'floatUp 1s ease-out forwards';
                
                cell.style.position = 'relative';
                cell.appendChild(floatingText);
                
                setTimeout(() => floatingText.remove(), 1000);
            }
            
            updateRobotDirection() {
                const robotElement = document.querySelector('.robot');
                if (robotElement) {
                    const directions = {
                        'right': 'ü§ñ‚û°Ô∏è',
                        'left': '‚¨ÖÔ∏èü§ñ',
                        'up': '‚¨ÜÔ∏èü§ñ',
                        'down': '‚¨áÔ∏èü§ñ'
                    };
                    robotElement.innerHTML = directions[this.robotDirection];
                }
            }
            
            collectStar(x, y) {
                this.totalStars++;
                this.updateUI();
                
                // Add visual feedback
                const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
                cell.classList.add('bounce');
                setTimeout(() => cell.classList.remove('bounce'), 500);
            }
            
            checkAchievements() {
                const newAchievements = [];
                
                // First gem
                if (this.score >= 100 && !this.achievements.includes('first_gem')) {
                    newAchievements.push({ id: 'first_gem', title: 'üíé ‡∏ô‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏û‡∏ä‡∏£', desc: '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏û‡∏ä‡∏£‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å' });
                }
                
                // Speed demon
                if (this.combo >= 3 && !this.achievements.includes('speed_demon')) {
                    newAchievements.push({ id: 'speed_demon', title: '‚ö° ‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤', desc: '‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° 3 ‡∏ä‡∏¥‡πâ‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô' });
                }
                
                // Perfect level
                if (this.attempts === 1 && this.currentLevel > 1 && !this.achievements.includes('perfect_' + this.currentLevel)) {
                    newAchievements.push({ id: 'perfect_' + this.currentLevel, title: 'üéØ ‡∏ô‡∏±‡∏Å‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', desc: '‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß' });
                }
                
                // Code master
                const currentBlocks = this.getCurrentCodeBlocks();
                if (currentBlocks.length <= this.levels[this.currentLevel].optimalMoves && !this.achievements.includes('code_master_' + this.currentLevel)) {
                    newAchievements.push({ id: 'code_master_' + this.currentLevel, title: 'üß† ‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏á', desc: '‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î' });
                }
                
                newAchievements.forEach(achievement => {
                    this.achievements.push(achievement.id);
                    this.showAchievement(achievement);
                });
            }
            
            showAchievement(achievement) {
                const achievementDiv = document.createElement('div');
                achievementDiv.className = 'bg-yellow-100 border border-yellow-300 rounded-lg p-3 mb-2 animate-pulse';
                achievementDiv.innerHTML = `
                    <div class="font-semibold text-yellow-800">${achievement.title}</div>
                    <div class="text-sm text-yellow-600">${achievement.desc}</div>
                `;
                
                const container = document.getElementById('achievements');
                if (container.children[0]?.textContent.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ')) {
                    container.innerHTML = '';
                }
                container.appendChild(achievementDiv);
                
                // Show floating achievement
                this.showFloatingAchievement(achievement.title);
            }
            
            showFloatingAchievement(title) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-20 right-4 bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-500';
                notification.innerHTML = `<div class="font-bold">üèÜ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà!</div><div class="text-sm">${title}</div>`;
                
                document.body.appendChild(notification);
                
                setTimeout(() => notification.classList.remove('translate-x-full'), 100);
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
            }
            
            gameOver(message) {
                this.stopTimer();
                alert(message);
                this.resetLevel();
            }
            
            checkWinCondition() {
                const level = this.levels[this.currentLevel];
                const allStarsCollected = level.stars.every(star => {
                    const { x, y } = this.robotPosition;
                    return star.x === x && star.y === y;
                });
                
                if (allStarsCollected) {
                    this.stopTimer();
                    const levelScore = this.calculateScore();
                    
                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏≤‡∏ô
                    if (!this.levelScores[this.currentLevel] || levelScore > this.levelScores[this.currentLevel]) {
                        this.levelScores[this.currentLevel] = levelScore;
                    }
                    
                    this.combo++;
                    this.completedLevels = Math.max(this.completedLevels, this.currentLevel);
                    
                    // Save best time
                    const timeUsed = this.levels[this.currentLevel].timeLimit - this.timeRemaining;
                    if (!this.bestTimes[this.currentLevel] || timeUsed < this.bestTimes[this.currentLevel]) {
                        this.bestTimes[this.currentLevel] = timeUsed;
                    }
                    
                    this.checkAchievements();
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    if (this.currentLevel === this.totalLevels) {
                        this.showFinalScoreModal();
                    } else {
                        this.showSuccessModal(levelScore);
                    }
                    
                    this.updateUI();
                }
            }
            
            showSuccessModal(levelScore) {
                const modal = document.getElementById('successModal');
                const message = document.getElementById('successMessage');
                
                const level = this.levels[this.currentLevel];
                const timeUsed = level.timeLimit - this.timeRemaining;
                const gemsCollected = (level.gems?.length || 0) - this.gems.length;
                const totalGems = level.gems?.length || 0;
                
                let rating = '‚≠ê';
                if (levelScore >= level.maxScore * 0.8) rating = '‚≠ê‚≠ê‚≠ê';
                else if (levelScore >= level.maxScore * 0.6) rating = '‚≠ê‚≠ê';
                
                message.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-2">${rating}</div>
                        <div class="text-lg font-bold mb-2">‡∏î‡πà‡∏≤‡∏ô ${this.currentLevel} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
                        <div class="space-y-1 text-sm text-gray-600">
                            <div>üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: +${levelScore}</div>
                            <div>‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: ${timeUsed}s</div>
                            <div>üíé ‡πÄ‡∏û‡∏ä‡∏£: ${gemsCollected}/${totalGems}</div>
                            <div>üî• ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö: ${this.combo}x</div>
                        </div>
                    </div>
                `;
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                document.getElementById('nextLevelBtn').style.display = 'inline-block';
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
            
            showFinalScoreModal() {
                const modal = document.getElementById('successModal');
                const message = document.getElementById('successMessage');
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏î‡πà‡∏≤‡∏ô
                const totalScore = Object.values(this.levelScores).reduce((sum, score) => sum + score, 0);
                const averageScore = totalScore / this.totalLevels;
                
                let finalRating = 'ü•â';
                if (averageScore >= 3000) finalRating = 'ü•á';
                else if (averageScore >= 2000) finalRating = 'ü•à';
                
                message.innerHTML = `
                    <div class="text-center">
                        <div class="text-6xl mb-4">üéâüëëüèÜ</div>
                        <div class="text-2xl font-bold mb-4 text-purple-600">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</div>
                        
                        <div class="bg-gradient-to-r from-purple-100 to-blue-100 rounded-xl p-4 mb-4">
                            <div class="text-4xl mb-2">${finalRating}</div>
                            <div class="text-xl font-bold text-gray-800">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
                            <div class="text-3xl font-bold text-purple-600">${totalScore.toLocaleString()}</div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-blue-600 font-semibold">‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô</div>
                                <div class="text-2xl font-bold">${this.completedLevels}/${this.totalLevels}</div>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-orange-600 font-semibold">‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
                                <div class="text-2xl font-bold">${this.maxCombo}x</div>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-green-600 font-semibold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                                <div class="text-2xl font-bold">${this.achievements.length}</div>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-purple-600 font-semibold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                                <div class="text-2xl font-bold">${Math.round(averageScore)}</div>
                            </div>
                        </div>
                        
                        <div class="text-sm text-gray-600 mb-4">
                            <div class="font-semibold mb-2">üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏î‡πà‡∏≤‡∏ô (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î):</div>
                            <div class="grid grid-cols-4 gap-2">
                                ${Array.from({length: this.totalLevels}, (_, i) => {
                                    const level = i + 1;
                                    const score = this.levelScores[level] || 0;
                                    return `<div class="bg-gray-100 rounded px-2 py-1">‡∏î‡πà‡∏≤‡∏ô${level}: ${score}</div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                document.getElementById('nextLevelBtn').style.display = 'none';
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
            
            hideSuccessModal() {
                const modal = document.getElementById('successModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            
            nextLevel() {
                this.hideSuccessModal();
                if (this.currentLevel < this.totalLevels) {
                    this.loadLevel(this.currentLevel + 1);
                }
            }
            
            resetLevel() {
                this.stopTimer();
                this.combo = 0; // Reset combo on manual reset
                this.loadLevel(this.currentLevel);
            }
            
            updateUI() {
                // Update desktop UI
                const scoreEl = document.getElementById('score');
                const starsEl = document.getElementById('stars');
                const gemsEl = document.getElementById('gems');
                const levelEl = document.getElementById('level');
                const timerEl = document.getElementById('timer');
                
                if (scoreEl) scoreEl.textContent = this.score.toLocaleString();
                if (starsEl) starsEl.textContent = this.totalStars;
                if (gemsEl) gemsEl.textContent = (this.levels[this.currentLevel]?.gems?.length || 0) - this.gems.length;
                if (levelEl) levelEl.textContent = this.currentLevel;
                if (timerEl) timerEl.textContent = this.timeRemaining || '--';
                
                // Update mobile UI
                const scoreMobileEl = document.getElementById('scoreMobile');
                const starsMobileEl = document.getElementById('starsMobile');
                const gemsMobileEl = document.getElementById('gemsMobile');
                const levelMobileEl = document.getElementById('levelMobile');
                const timerMobileEl = document.getElementById('timerMobile');
                
                if (scoreMobileEl) scoreMobileEl.textContent = this.score.toLocaleString();
                if (starsMobileEl) starsMobileEl.textContent = this.totalStars;
                if (gemsMobileEl) gemsMobileEl.textContent = (this.levels[this.currentLevel]?.gems?.length || 0) - this.gems.length;
                if (levelMobileEl) levelMobileEl.textContent = this.currentLevel;
                if (timerMobileEl) timerMobileEl.textContent = this.timeRemaining || '--';
                
                // Update other UI elements
                document.getElementById('completedLevels').textContent = `${this.completedLevels}/${this.totalLevels}`;
                document.getElementById('combo').textContent = `${this.combo}x`;
                document.getElementById('attempts').textContent = this.attempts;
                
                // Update energy bars (both desktop and mobile)
                const energyPercent = (this.energy / this.maxEnergy) * 100;
                const energyBars = [document.getElementById('energyBar'), document.getElementById('energyBarMobile')];
                
                energyBars.forEach(energyBar => {
                    if (energyBar) {
                        energyBar.style.width = `${energyPercent}%`;
                        
                        if (energyPercent <= 20) {
                            energyBar.className = 'bg-red-500 h-2 rounded-full transition-all duration-300';
                        } else if (energyPercent <= 50) {
                            energyBar.className = 'bg-yellow-500 h-2 rounded-full transition-all duration-300';
                        } else {
                            energyBar.className = 'bg-green-500 h-2 rounded-full transition-all duration-300';
                        }
                    }
                });
                
                const progress = (this.completedLevels / this.totalLevels) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
            }
        }
        
        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Viewport height fix for mobile browsers
            const setVH = () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };
            
            setVH();
            window.addEventListener('resize', setVH);
            window.addEventListener('orientationchange', () => {
                setTimeout(setVH, 100);
            });
            
            // Prevent zoom on double tap for iOS
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (event) => {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Prevent pull-to-refresh on mobile
            document.body.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1 && window.scrollY === 0) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.body.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1 && window.scrollY === 0) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Initialize game
            new RobotCodeGame();
            
            // Performance monitoring
            if ('performance' in window) {
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        const perfData = performance.getEntriesByType('navigation')[0];
                        console.log('Page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
                    }, 0);
                });
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97f74185d513a1ae',t:'MTc1NzkzMDIwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
