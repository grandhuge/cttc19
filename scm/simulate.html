<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title updated -->
    <title>โปรแกรมประเมินระดับชั้นความเข้มแข็งสหกรณ์</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=inter:wght@400;500;600;700&family=noto+sans+thai:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 3. Custom Styles -->
    <style>
        body {
            font-family: 'Inter', 'Noto Sans Thai', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* ซ่อน step ที่ไม่ได้ active */
        .scm-step {
            display: none;
        }
        .scm-step.active {
            display: block;
        }
        /* Custom progress bar */
        .progress-bar-bg {
            background-color: #e5e7eb; /* bg-gray-200 */
        }
        .progress-bar-fg {
            background-color: #2563eb; /* bg-blue-600 */
            transition: width 0.3s ease-in-out;
        }
        /* Custom styles for inputs */
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #2563eb; /* border-blue-600 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* focus:ring-blue-500/25 */
        }
        /* Style for invalid inputs */
        .form-input:invalid:not(:placeholder-shown) {
             border-color: #ef4444; /* border-red-500 */
        }
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            background-color: white;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
         /* Style for invalid selects */
        .form-select:invalid:not(:placeholder-shown) {
             border-color: #ef4444; /* border-red-500 */
        }
        .form-label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500; /* font-medium */
            color: #374151; /* text-gray-700 */
        }
        .form-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            border: 1px solid #d1d5db;
            color: #2563eb; /* text-blue-600 */
            margin-right: 0.5rem;
        }
        .form-checkbox:focus {
            ring: 2px solid #2563eb;
        }
        .form-radio {
            width: 1.25rem;
            height: 1.25rem;
            border: 1px solid #d1d5db;
            color: #2563eb;
            margin-right: 0.5rem;
        }
        /* Button styles */
        .btn {
            padding: 0.65rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
            transition: all 0.2s;
            cursor: pointer;
            display: inline-flex; /* Align icon and text */
            align-items: center;
            justify-content: center;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
        }
        .btn-secondary {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #d1d5db; /* hover:bg-gray-300 */
        }
        .btn-success {
            background-color: #16a34a; /* bg-green-600 */
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            background-color: #15803d; /* hover:bg-green-700 */
        }
        .btn-warning {
            background-color: #ca8a04; /* bg-yellow-600 */
            color: white;
        }
        .btn-warning:hover:not(:disabled) {
            background-color: #a16207; /* hover:bg-yellow-700 */
        }
         .btn-danger {
            background-color: #dc2626; /* bg-red-600 */
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background-color: #b91c1c; /* hover:bg-red-700 */
        }
        /* Step Content Box */
        .step-box {
            background-color: white;
            padding: 2rem; /* p-8 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
        }
        .fieldset-box {
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            margin-top: 1.5rem; /* mt-6 */
        }
        .legend-text {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #111827; /* text-gray-900 */
            padding: 0 0.5rem; /* px-2 */
        }
        /* Modal base styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 50; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
        }
        .modal.active {
            display: flex; /* Show when active */
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
            width: 90%;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            position: relative; /* For close button positioning */
        }
        /* Specific modal content sizes */
        .modal-content-results {
             max-width: 48rem; /* max-w-3xl */
        }
        .modal-content-alert {
             max-width: 32rem; /* max-w-lg */
        }

        .modal-close {
            color: #aaa;
            position: absolute; /* Position relative to modal-content */
            top: 0.75rem;
            right: 1rem;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #374151; /* text-gray-700 */
            text-decoration: none;
            cursor: pointer;
        }

        /* Spinner for loading */
         .spinner {
            border: 4px solid #f3f4f6; /* light grey */
            border-top: 4px solid #3b82f6; /* blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 8px; /* Add some space between spinner and text */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
             display: none;
        }

    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <main class="max-w-4xl mx-auto">
        <header class="mb-6">
            <!-- Title updated -->
            <h1 class="text-3xl md:text-4xl font-bold text-center text-blue-800">โปรแกรมประเมินระดับชั้นความเข้มแข็งสหกรณ์</h1>
            <p class="text-center text-lg text-gray-600 mt-2">(SCM - Strength Calculation Model)</p>
            <p class="text-center text-sm text-gray-500 mt-1">อ้างอิงเกณฑ์การประเมิน พ.ศ. 2566 – 2570</p>
        </header>

        <!-- Import/Export Buttons -->
        <div class="flex justify-center gap-4 mb-6">
            <button id="importBtn" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                นำเข้าข้อมูล (Import)
            </button>
            <input type="file" id="fileInput" class="hidden" accept=".json">
            <button id="exportBtn" class="btn btn-secondary">
                 <span id="exportSpinner" class="spinner hidden"></span> <!-- Spinner added -->
                <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-5 w-5 mr-1 icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                <span class="text">ส่งออกข้อมูล (Export)</span>
            </button>
        </div>

        <!-- Progress Bar -->
        <div class="w-full progress-bar-bg rounded-full h-4 mb-6 shadow-inner">
            <div id="progressBar" class="progress-bar-fg h-4 rounded-full" style="width: 20%"></div>
        </div>

        <!-- Form Steps -->
        <form id="scmForm" class="step-box">

            <!-- ======================================= -->
            <!-- Step 1: Setup & Fundamental Conditions  -->
            <!-- ======================================= -->
            <div id="step1" class="scm-step active">
                <fieldset class="fieldset-box border-blue-200">
                    <legend class="legend-text text-blue-700">ขั้นตอนที่ 1: ข้อมูลตั้งค่าพื้นฐาน</legend>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="coop_type" class="form-label">1. เลือกประเภทสหกรณ์ <span class="text-red-500">*</span></label>
                            <select id="coop_type" name="coop_type" class="form-select" required>
                                <option value="">-- กรุณาเลือก --</option>
                                <option value="Ag">สหกรณ์ภาคการเกษตร (สกก., สกน., สกป.)</option>
                                <option value="NonAg">สหกรณ์นอกภาคการเกษตร (สกอ., สกร., สกบ., สกค.)</option>
                            </select>
                        </div>
                        <div>
                            <label for="fiscal_year_end_date" class="form-label">2. วันสิ้นปีทางบัญชี (ที่ประเมิน) <span class="text-red-500">*</span></label>
                            <input type="date" id="fiscal_year_end_date" name="fiscal_year_end_date" class="form-input" required>
                            <p class="text-xs text-gray-500 mt-1">เช่น 31/03/2568 (ใช้สำหรับคำนวณ 150 วัน)</p>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="fieldset-box border-gray-200">
                    <legend class="legend-text text-gray-700">เงื่อนไขพื้นฐาน (สำหรับการจัดชั้น)</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="d_base_books_closed" class="form-label">3. สถานะการปิดบัญชี (ปีที่ประเมิน) <span class="text-red-500">*</span></label>
                            <select id="d_base_books_closed" name="d_base_books_closed" class="form-select" required>
                                <option value="">-- กรุณาเลือก --</option>
                                <option value="yes">ปิดบัญชีได้</option>
                                <option value="no">ปิดบัญชีไม่ได้</option>
                            </select>
                        </div>
                        <div>
                            <label for="d_base_meeting_held" class="form-label">4. สถานะการประชุมใหญ่ (ปีที่ประเมิน) <span class="text-red-500">*</span></label>
                            <select id="d_base_meeting_held" name="d_base_meeting_held" class="form-select" required>
                                <option value="">-- กรุณาเลือก --</option>
                                <option value="yes">ประชุมใหญ่สามัญได้</option>
                                <option value="no">ประชุมใหญ่สามัญไม่ได้</option>
                            </select>
                        </div>
                    </div>
                </fieldset>
            </div>

            <!-- ======================================= -->
            <!-- Step 2: Dimension 4 (30 Points)         -->
            <!-- ======================================= -->
            <div id="step2" class="scm-step">
                <fieldset class="fieldset-box border-red-200">
                    <legend class="legend-text text-red-700">ขั้นตอนที่ 2: มิติที่ 4 ประสิทธิภาพของการบริหารงาน (30 คะแนน)</legend>

                    <!-- 4.3 งบการเงินและอนุมัติ -->
                    <div class="mb-4 p-4 border border-gray-200 rounded-lg">
                        <h4 class="font-semibold text-lg text-gray-800">ตชว. 4.3 (งบการเงินและอนุมัติ)</h4>
                        <p class="text-sm text-gray-500 mb-4">(ข้อมูลจาก "วันสิ้นปีทางบัญชี" ในขั้นตอนที่ 1 จะใช้คำนวณ)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="d4_3_send_date" class="form-label">วันที่สหกรณ์ส่งหนังสือถึงผู้สอบบัญชี <span class="text-red-500">*</span></label>
                                <input type="date" id="d4_3_send_date" name="d4_3_send_date" class="form-input" required>
                            </div>
                            <div>
                                <label for="d4_3_approve_date" class="form-label">วันที่ประชุมใหญ่สามัญอนุมัติงบการเงิน <span class="text-red-500">*</span></label>
                                <input type="date" id="d4_3_approve_date" name="d4_3_approve_date" class="form-input" required>
                            </div>
                        </div>
                    </div>

                    <!-- 4.2 ผลประกอบการ 2 ปี -->
                    <div class="mb-4 p-4 border border-gray-200 rounded-lg">
                        <h4 class="font-semibold text-lg text-gray-800">ตชว. 4.2 (ผลประกอบการ 2 ปี)</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="d4_2_profit_current_year" class="form-label">ผลกำไร/ขาดทุนสุทธิ (ปีที่ประเมิน) <span class="text-red-500">*</span></label>
                                <!-- step attribute added -->
                                <input type="number" step="0.01" id="d4_2_profit_current_year" name="d4_2_profit_current_year" class="form-input" placeholder="ใส่ตัวเลข (ติดลบได้)" required>
                            </div>
                            <div>
                                <label for="d4_2_profit_prev_year" class="form-label">ผลกำไร/ขาดทุนสุทธิ (ปีที่แล้ว) <span class="text-red-500">*</span></label>
                                <!-- step attribute added -->
                                <input type="number" step="0.01" id="d4_2_profit_prev_year" name="d4_2_profit_prev_year" class="form-input" placeholder="ใส่ตัวเลข (ติดลบได้)" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="form-label">สถานะการขาดทุนเนื่องจากข้อยกเว้น (ภัยธรรมชาติ/โรคระบาด)</label>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center"><input type="radio" name="d4_2_exception" value="no" class="form-radio" checked> ไม่มีข้อยกเว้น</label>
                                    <label class="flex items-center"><input type="radio" name="d4_2_exception" value="yes" class="form-radio"> มีข้อยกเว้น (โปรดระบุ)</label>
                                </div>
                                <input type="text" id="d4_2_exception_detail" name="d4_2_exception_detail" class="form-input mt-2" placeholder="ระบุเลขที่หนังสือราชการ (ถ้ามี)">
                            </div>
                        </div>
                    </div>

                    <!-- 4.1 ข้อบกพร่อง/ทุจริต -->
                    <div class="mb-4 p-4 border border-gray-200 rounded-lg">
                        <h4 class="font-semibold text-lg text-gray-800">ตชว. 4.1 (ข้อบกพร่อง/ทุจริต)</h4>
                        <div>
                            <label for="d4_1_status" class="form-label">สถานะการแก้ไขข้อบกพร่อง (เลือกสถานะที่ต่ำที่สุด) <span class="text-red-500">*</span></label>
                            <select id="d4_1_status" name="d4_1_status" class="form-select" required>
                                <option value="15">เสร็จสมบูรณ์ (ขั้นสูง)</option>
                                <option value="10">เสร็จต้องติดตาม (ขั้นกลาง)</option>
                                <option value="5">อยู่ระหว่างดำเนินการแก้ไข (ขั้นต้น)</option>
                                <option value="0">ยังไม่เริ่มดำเนินการแก้ไข / ตรวจพบ (ขั้นเตรียม)</option>
                            </select>
                        </div>
                    </div>

                    <!-- 4.4 เจ้าหน้าที่ประจำ -->
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <h4 class="font-semibold text-lg text-gray-800">ตชว. 4.4 (เจ้าหน้าที่ประจำ)</h4>
                        <div>
                            <label for="d4_4_status" class="form-label">สถานะการจ้างเจ้าหน้าที่ <span class="text-red-500">*</span></label>
                            <select id="d4_4_status" name="d4_4_status" class="form-select" required>
                                <option value="5">จ้างประจำ (ขั้นสูง)</option>
                                <option value="3">จ้างชั่วคราว / รวมกันจ้าง (ขั้นกลาง)</option>
                                <option value="2">คำสั่งมอบหมาย (มีผู้ปฏิบัติหน้าที่) (ขั้นต้น)</option>
                                <option value="0">ไม่มีคำสั่งมอบหมาย / ไม่ได้ปฏิบัติงาน (ขั้นเตรียม)</option>
                            </select>
                        </div>
                    </div>
                </fieldset>
            </div>

            <!-- ======================================= -->
            <!-- Step 3: Dimension 1 (30 Points)         -->
            <!-- ======================================= -->
            <div id="step3" class="scm-step">
                <fieldset class="fieldset-box border-green-200">
                    <legend class="legend-text text-green-700">ขั้นตอนที่ 3: มิติที่ 1 ความสามารถในการให้บริการสมาชิก (30 คะแนน)</legend>

                    <!-- 1.1 สมาชิกมีส่วนร่วม -->
                    <div class="mb-4 p-4 border border-gray-200 rounded-lg">
                        <h4 class="font-semibold text-lg text-gray-800">ตชว. 1.1 (สมาชิกมีส่วนร่วม)</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="d1_1_total_members" class="form-label">จำนวนสมาชิก (ไม่รวมสมทบ) ทั้งหมด <span class="text-red-500">*</span></label>
                                <input type="number" id="d1_1_total_members" name="d1_1_total_members" class="form-input" placeholder="0" min="0" required>
                            </div>
                            <div>
                                <label for="d1_1_active_members" class="form-label">จำนวนสมาชิก (ไม่รวมสมทบ) ที่มีส่วนร่วม (สูงสุด) <span class="text-red-500">*</span></label>
                                <input type="number" id="d1_1_active_members" name="d1_1_active_members" class="form-input" placeholder="0" min="0" required>
                            </div>
                        </div>
                    </div>

                    <!-- 1.2 ทุนสวัสดิการ 2 ปี -->
                    <div class="mb-4 p-4 border border-gray-200 rounded-lg">
                        <h4 class="font-semibold text-lg text-gray-800">ตชว. 1.2 (ทุนสวัสดิการ 2 ปี)</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- ปีที่ประเมิน -->
                            <div>
                                <label class="form-label font-medium">ปีที่ประเมิน (Current)</label>
                                <div class="space-y-2 mt-2">
                                    <label class="flex items-center"><input type="checkbox" id="d1_2_welfare_allocated_current" name="d1_2_welfare_allocated_current" class="form-checkbox"> มีการจัดสรรทุนสวัสดิการสมาชิก</label>
                                    <label class="flex items-center"><input type="checkbox" id="d1_2_welfare_paid_current" name="d1_2_welfare_paid_current" class="form-checkbox"> มีการจ่ายทุนสวัสดิการสมาชิก</label>
                                    <label class="flex items-center"><input type="checkbox" id="d1_2_public_allocated_current" name="d1_2_public_allocated_current" class="form-checkbox"> มีการจัดสรรทุนสาธารณประโยชน์</label>
                                    <label class="flex items-center"><input type="checkbox" id="d1_2_public_paid_current" name="d1_2_public_paid_current" class="form-checkbox"> มีการจ่ายทุนสาธารณประโยชน์</label>
                                </div>
                            </div>
                            <!-- ปีที่แล้ว -->
                            <div>
                                <label class="form-label font-medium">ปีที่แล้ว (Previous)</label>
                                <div class="space-y-2 mt-2">
                                    <label class="flex items-center"><input type="checkbox" id="d1_2_welfare_allocated_prev" name="d1_2_welfare_allocated_prev" class="form-checkbox"> มีการจัดสรรทุนสวัสดิการสมาชิก</label>
                                    <label class="flex items-center"><input type="checkbox" id="d1_2_welfare_paid_prev" name="d1_2_welfare_paid_prev" class="form-checkbox"> มีการจ่ายทุนสวัสดิการสมาชิก</label>
                                    <label class="flex items-center"><input type="checkbox" id="d1_2_public_allocated_prev" name="d1_2_public_allocated_prev" class="form-checkbox"> มีการจัดสรรทุนสาธารณประโยชน์</label>
                                    <label class="flex items-center"><input type="checkbox" id="d1_2_public_paid_prev" name="d1_2_public_paid_prev" class="form-checkbox"> มีการจ่ายทุนสาธารณประโยชน์</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 1.3 จำนวนประเภทธุรกิจ (เฉพาะภาคเกษตร) -->
                    <div id="d1_3_section" class="p-4 border border-gray-200 rounded-lg" style="display: none;">
                        <h4 class="font-semibold text-lg text-gray-800">ตชว. 1.3 (จำนวนประเภทธุรกิจ)</h4>
                        <p class="text-sm text-gray-500 mb-4">(เฉพาะสหกรณ์ภาคการเกษตร)</p>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <label class="flex items-center"><input type="checkbox" name="d1_3_biz_types" value="1" class="form-checkbox"> รับฝากเงิน</label>
                            <label class="flex items-center"><input type="checkbox" name="d1_3_biz_types" value="1" class="form-checkbox"> สินเชื่อ</label>
                            <label class="flex items-center"><input type="checkbox" name="d1_3_biz_types" value="1" class="form-checkbox"> รวบรวมผลผลิต</label>
                            <label class="flex items-center"><input type="checkbox" name="d1_3_biz_types" value="1" class="form-checkbox"> แปรรูป</label>
                            <label class="flex items-center"><input type="checkbox" name="d1_3_biz_types" value="1" class="form-checkbox"> จัดหาสินค้า</label>
                            <label class="flex items-center"><input type="checkbox" name="d1_3_biz_types" value="1" class="form-checkbox"> บริการ/ส่งเสริม</label>
                        </div>
                    </div>

                </fieldset>
            </div>

            <!-- ======================================= -->
            <!-- Step 4: Dimension 2 (20 Points)         -->
            <!-- ======================================= -->
            <div id="step4" class="scm-step">
                <fieldset class="fieldset-box border-yellow-200">
                    <legend class="legend-text text-yellow-700">ขั้นตอนที่ 4: มิติที่ 2 ประสิทธิภาพในการดำเนินธุรกิจ (20 คะแนน)</legend>
                    <p class="text-sm text-gray-600 mb-4">กรอกข้อมูลดิบจากงบการเงิน เพื่อใช้คำนวณอัตราส่วนทางการเงิน</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <!-- 2.1 -->
                        <div>
                            <label for="d2_raw_total_debt" class="form-label">(2.1) หนี้สินทั้งสิ้น</label>
                            <input type="number" step="0.01" id="d2_raw_total_debt" name="d2_raw_total_debt" class="form-input" placeholder="0.00" required>
                        </div>
                        <div>
                            <label for="d2_raw_total_capital" class="form-label">(2.1) รวมทุนของสหกรณ์</label>
                            <input type="number" step="0.01" id="d2_raw_total_capital" name="d2_raw_total_capital" class="form-input" placeholder="0.00" required>
                        </div>
                        <!-- 2.2 -->
                        <div>
                            <label for="d2_raw_reserve_fund" class="form-label">(2.2) ทุนสำรอง</label>
                            <input type="number" step="0.01" id="d2_raw_reserve_fund" name="d2_raw_reserve_fund" class="form-input" placeholder="0.00" required>
                        </div>
                        <div>
                            <label for="d2_raw_assets_current" class="form-label">(2.2 & 2.3) สินทรัพย์ทั้งสิ้น (ปีปัจจุบัน)</label>
                            <input type="number" step="0.01" id="d2_raw_assets_current" name="d2_raw_assets_current" class="form-input" placeholder="0.00" required>
                        </div>
                        <!-- 2.3 -->
                        <div>
                            <label for="d2_raw_assets_prev" class="form-label">(2.3) สินทรัพย์ทั้งสิ้น (ปีก่อน)</label>
                            <input type="number" step="0.01" id="d2_raw_assets_prev" name="d2_raw_assets_prev" class="form-input" placeholder="0.00" required>
                        </div>
                        <div>
                            <label for="d2_raw_operating_profit" class="form-label">(2.3) กำไรขาดทุนจากการดำเนินงาน</label>
                            <input type="number" step="0.01" id="d2_raw_operating_profit" name="d2_raw_operating_profit" class="form-input" placeholder="0.00" required>
                        </div>
                        <!-- 2.4 -->
                        <div>
                            <label for="d2_raw_operating_expense" class="form-label">(2.4) ค่าใช้จ่ายดำเนินงาน</label>
                            <input type="number" step="0.01" id="d2_raw_operating_expense" name="d2_raw_operating_expense" class="form-input" placeholder="0.00" required>
                        </div>
                        <div>
                            <label for="d2_raw_profit_before_expense" class="form-label">(2.4) กำไรก่อนหักค่าใช้จ่ายดำเนินงาน</label>
                            <input type="number" step="0.01" id="d2_raw_profit_before_expense" name="d2_raw_profit_before_expense" class="form-input" placeholder="0.00" required>
                        </div>
                        <!-- 2.5 -->
                        <div>
                            <label for="d2_raw_current_assets" class="form-label">(2.5) สินทรัพย์หมุนเวียน</label>
                            <input type="number" step="0.01" id="d2_raw_current_assets" name="d2_raw_current_assets" class="form-input" placeholder="0.00" required>
                        </div>
                        <div>
                            <label for="d2_raw_current_liabilities" class="form-label">(2.5) หนี้สินหมุนเวียน</label>
                            <input type="number" step="0.01" id="d2_raw_current_liabilities" name="d2_raw_current_liabilities" class="form-input" placeholder="0.00" required>
                        </div>
                        <!-- 2.6 -->
                        <div class="md:col-span-2 border-t pt-4 mt-2">
                            <label for="d2_raw_has_short_term_loan_biz" class="form-label">(2.6) ดำเนินธุรกิจสินเชื่อระยะสั้นหรือไม่?</label>
                            <select id="d2_raw_has_short_term_loan_biz" name="d2_raw_has_short_term_loan_biz" class="form-select" required>
                                <option value="yes">ใช่ (ดำเนินธุรกิจสินเชื่อระยะสั้น)</option>
                                <option value="no">ไม่ (ไม่ได้ดำเนินธุรกิจ - จะโอนคะแนน 2.6 ไป 2.5)</option>
                            </select>
                        </div>
                        <div>
                            <label for="d2_raw_short_term_debt_paid" class="form-label">(2.6) ลูกหนี้ระยะสั้นที่ชำระหนี้ได้ตามกำหนด</label>
                            <input type="number" step="0.01" id="d2_raw_short_term_debt_paid" name="d2_raw_short_term_debt_paid" class="form-input" placeholder="0.00">
                        </div>
                        <div>
                            <label for="d2_raw_short_term_debt_due" class="form-label">(2.6) ลูกหนี้ระยะสั้นที่ถึงกำหนดชำระ</label>
                            <input type="number" step="0.01" id="d2_raw_short_term_debt_due" name="d2_raw_short_term_debt_due" class="form-input" placeholder="0.00">
                        </div>

                    </div>
                </fieldset>
            </div>

            <!-- ======================================= -->
            <!-- Step 5: Dimension 3 (20 Points)         -->
            <!-- ======================================= -->
            <div id="step5" class="scm-step">
                <fieldset class="fieldset-box border-purple-200">
                    <legend class="legend-text text-purple-700">ขั้นตอนที่ 5: มิติที่ 3 ประสิทธิภาพในการจัดการองค์กร (20 คะแนน)</legend>

                    <!-- 3.1 เทคโนโลยีการบัญชี -->
                    <div class="mb-4 p-4 border border-gray-200 rounded-lg">
                        <h4 class="font-semibold text-lg text-gray-800">ตชว. 3.1 (เทคโนโลยีการบัญชี)</h4>
                        <div>
                            <label for="d3_1_status" class="form-label">ระดับการใช้โปรแกรมบัญชี <span class="text-red-500">*</span></label>
                            <select id="d3_1_status" name="d3_1_status" class="form-select" required>
                                <option value="4">ใช้งานเต็มระบบ</option>
                                <option value="2">ใช้งานบางส่วน</option>
                                <option value="0">ไม่ได้ใช้งาน</option>
                            </select>
                        </div>
                    </div>

                    <!-- 3.2 - 3.5 การควบคุมภายใน -->
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <h4 class="font-semibold text-lg text-gray-800">ตชว. 3.2 - 3.5 (การควบคุมภายใน)</h4>
                        <p class="text-sm text-gray-500 mb-4">เลือกระดับการควบคุมภายในสำหรับแต่ละส่วน</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="d3_2_status" class="form-label">3.2 สภาพแวดล้อมการควบคุม</label>
                                <select id="d3_2_status" name="d3_2_status" class="form-select" required>
                                    <option value="3">ดีมาก (> 95)</option>
                                    <option value="2">ดี (80 - 95)</option>
                                    <option value="1">พอใช้ (60 - 80)</option>
                                    <option value="0">ต้องปรับปรุง (≤ 60) / ไม่มี</option>
                                </select>
                            </div>
                            <div>
                                <label for="d3_3_status" class="form-label">3.3 ความเสี่ยงและกิจกรรมควบคุม</label>
                                <select id="d3_3_status" name="d3_3_status" class="form-select" required>
                                    <option value="3">ดีมาก (> 95)</option>
                                    <option value="2">ดี (80 - 95)</option>
                                    <option value="1">พอใช้ (60 - 80)</option>
                                    <option value="0">ต้องปรับปรุง (≤ 60) / ไม่มี</option>
                                </select>
                            </div>
                            <div>
                                <label for="d3_4_status" class="form-label">3.4 ระบบข้อมูลสารสนเทศและการสื่อสาร</label>
                                <select id="d3_4_status" name="d3_4_status" class="form-select" required>
                                    <option value="3">ดีมาก (> 95)</option>
                                    <option value="2">ดี (80 - 95)</option>
                                    <option value="1">พอใช้ (60 - 80)</option>
                                    <option value="0">ต้องปรับปรุง (≤ 60) / ไม่มี</option>
                                </select>
                            </div>
                            <div>
                                <label for="d3_5_status" class="form-label">3.5 ระบบการติดตามและประเมินผล</label>
                                <select id="d3_5_status" name="d3_5_status" class="form-select" required>
                                    <option value="3">ดีมาก (> 95)</option>
                                    <option value="2">ดี (80 - 95)</option>
                                    <option value="1">พอใช้ (60 - 80)</option>
                                    <option value="0">ต้องปรับปรุง (≤ 60) / ไม่มี</option>
                                </select>
                            </div>
                        </div>
                    </div>

                </fieldset>
            </div>


            <!-- Navigation -->
            <div class="flex justify-between mt-8">
                <button type="button" id="prevBtn" class="btn btn-secondary" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                    ย้อนกลับ
                </button>
                <button type="button" id="nextBtn" class="btn btn-primary ml-auto">
                    ถัดไป
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
                <button type="submit" id="calculateBtn" class="btn btn-success ml-auto" style="display: none;">
                     <span id="calcSpinner" class="spinner hidden"></span> <!-- Spinner added -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-5 w-5 mr-1 icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                    <span class="text">คำนวณผล</span>
                </button>
            </div>
        </form>
    </main>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal">
        <div class="modal-content modal-content-results"> <!-- Added specific class -->
            <span id="modalCloseBtnResults" class="modal-close">&times;</span> <!-- Unique ID -->
            <h2 class="text-2xl font-bold text-gray-900 mb-4">ผลการประเมินความเข้มแข็งสหกรณ์</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left: Final Class -->
                <div class="flex flex-col items-center justify-center p-6 bg-gray-50 rounded-lg">
                    <p class="text-lg text-gray-600">ผลการจัดชั้น</p>
                    <div id="finalClassDisplay" class="text-8xl font-bold my-4 text-gray-800">?</div>
                    <div id="finalClassName" class="text-2xl font-semibold text-gray-800">...</div>
                    <p id="finalClassReason" class="text-sm text-gray-500 text-center mt-2">...</p>
                </div>

                <!-- Right: Score Summary -->
                <div class="space-y-4">
                    <div class="flex justify-between items-baseline p-4 bg-blue-50 rounded-lg">
                        <span class="font-semibold text-blue-800">คะแนนรวม 4 มิติ</span>
                        <span id="totalScoreDisplay" class="text-3xl font-bold text-blue-800">0.00 / 100</span>
                    </div>
                    <div class="flex justify-between p-3 border-b">
                        <span class="text-gray-700">มิติที่ 1 (ให้บริการสมาชิก)</span>
                        <span id="d1ScoreDisplay" class="font-medium text-gray-900">0.00 / 30.00</span>
                    </div>
                    <div class="flex justify-between p-3 border-b">
                        <span class="text-gray-700">มิติที่ 2 (ดำเนินธุรกิจ)</span>
                        <span id="d2ScoreDisplay" class="font-medium text-gray-900">0.00 / 20.00</span>
                    </div>
                    <div class="flex justify-between p-3 border-b">
                        <span class="text-gray-700">มิติที่ 3 (จัดการองค์กร)</span>
                        <span id="d3ScoreDisplay" class="font-medium text-gray-900">0.00 / 20.00</span>
                    </div>
                    <div class="flex justify-between p-3 border-b">
                        <span class="text-gray-700">มิติที่ 4 (บริหารงาน)</span>
                        <span id="d4ScoreDisplay" class="font-medium text-gray-900">0.00 / 30.00</span>
                    </div>
                </div>
            </div>

            <!-- Detailed Breakdown -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">รายละเอียดคะแนนรายตัวชี้วัด:</h3>
                <div id="detailedBreakdown" class="text-sm text-gray-700 space-y-1 bg-gray-50 p-4 rounded-lg max-h-48 overflow-y-auto">
                    <!-- Content generated by JS -->
                </div>
            </div>

             <!-- Conditions Check -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">สถานะการตรวจสอบเงื่อนไข:</h3>
                <div id="conditionsBreakdown" class="text-sm space-y-2">
                    <!-- Content generated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content modal-content-alert"> <!-- Specific class for styling -->
            <span id="alertModalCloseBtn" class="modal-close">&times;</span>
            <h2 id="alertModalTitle" class="text-xl font-bold text-gray-900 mb-3">แจ้งเตือน</h2>
            <p id="alertModalMessage" class="text-gray-700 mb-5">ข้อความแจ้งเตือน...</p>
            <div class="text-right">
                <button id="alertModalOkBtn" class="btn btn-primary">ตกลง</button>
            </div>
        </div>
    </div>


    <!-- JavaScript -->
    <script>
        // ใช้ IIFE (Immediately Invoked Function Expression) เพื่อป้องกันการชนกับตัวแปร global
        (function() {
            // App state
            let currentStep = 1;
            const totalSteps = 5;
            let formData = {};
            let scores = {};
            let coopType = '';

            // DOM Elements
            const form = document.getElementById('scmForm');
            const progressBar = document.getElementById('progressBar');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const calculateBtn = document.getElementById('calculateBtn');
            const calcSpinner = document.getElementById('calcSpinner'); // Spinner for calculate
            const steps = document.querySelectorAll('.scm-step');

            // Results Modal Elements
            const resultsModal = document.getElementById('resultsModal');
            const modalCloseBtnResults = document.getElementById('modalCloseBtnResults');

            // Alert Modal Elements
            const alertModal = document.getElementById('alertModal');
            const alertModalCloseBtn = document.getElementById('alertModalCloseBtn');
            const alertModalOkBtn = document.getElementById('alertModalOkBtn');
            const alertModalTitle = document.getElementById('alertModalTitle');
            const alertModalMessage = document.getElementById('alertModalMessage');

            // Import/Export Elements
            const importBtn = document.getElementById('importBtn');
            const exportBtn = document.getElementById('exportBtn');
            const exportSpinner = document.getElementById('exportSpinner'); // Spinner for export
            const fileInput = document.getElementById('fileInput');

            // --- Helper Functions (Moved to IIFE Scope) ---

            // Helper function to get standard score (3, 2, 1, 0) based on PDF thresholds
            function getStdScore(value, thresholdsForType, direction) {
                if (value === null || isNaN(value)) return 0;
                // thresholdsForType = [high_threshold, mid_threshold, low_threshold]
                // direction = 1 means higher is better (>), -1 means lower is better (<)

                if (direction === 1) { // Higher is better
                    if (value > thresholdsForType[0]) return 3; // ขั้นสูง
                    if (value >= thresholdsForType[1]) return 2; // ขั้นกลาง (>= mid)
                    if (value >= thresholdsForType[2]) return 1; // ขั้นต้น (>= low)
                    return 0; // ขั้นเตรียม
                } else { // Lower is better
                    if (value < thresholdsForType[0]) return 3; // ขั้นสูง
                    if (value <= thresholdsForType[1]) return 2; // ขั้นกลาง (<= mid)
                    if (value <= thresholdsForType[2]) return 1; // ขั้นต้น (<= low)
                    return 0; // ขั้นเตรียม
                }
            }

            // Helper to get score from weighted std score
            function getWeightedScore(stdScore, weight) {
                // Check if weight is defined and not zero to avoid division by zero or NaN
                if (typeof weight !== 'number' || weight === 0 || stdScore < 0 || stdScore > 3) return 0;
                // Calculate score based on standard score (0-3) and weight
                // scoreMap index corresponds to stdScore (0, 1, 2, 3)
                const scoreMap = [0, weight / 3, (weight * 2) / 3, weight]; // 0, 1/3, 2/3, full weight
                // Round to 2 decimal places to match user's expected scores (like 1.33, 2.67)
                return parseFloat(scoreMap[stdScore].toFixed(2));
            }


            // --- Step Navigation ---

            function showStep(stepNum) {
                steps.forEach((step, index) => {
                    step.classList.toggle('active', index + 1 === stepNum);
                });

                // Update progress bar
                progressBar.style.width = `${(stepNum / totalSteps) * 100}%`;

                // Update button visibility
                prevBtn.style.display = (stepNum === 1) ? 'none' : 'inline-flex';
                nextBtn.style.display = (stepNum === totalSteps) ? 'none' : 'inline-flex';
                calculateBtn.style.display = (stepNum === totalSteps) ? 'inline-flex' : 'none';
            }

            function nextStep() {
                // Remove previous invalid states before validating
                clearValidationErrors(currentStep);
                if (currentStep < totalSteps) {
                    if (validateStep(currentStep)) {
                        currentStep++;
                        showStep(currentStep);
                         window.scrollTo(0, 0); // Scroll to top on step change
                    }
                }
            }

            function prevStep() {
                 clearValidationErrors(currentStep); // Clear errors when going back too
                if (currentStep > 1) {
                    currentStep--;
                    showStep(currentStep);
                     window.scrollTo(0, 0); // Scroll to top on step change
                }
            }

             function clearValidationErrors(stepNum) {
                const currentStepEl = document.getElementById(`step${stepNum}`);
                const inputs = currentStepEl.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.style.borderColor = '#d1d5db'; // Reset border
                });
            }

            function validateStep(stepNum) {
                const currentStepEl = document.getElementById(`step${stepNum}`);
                // Use browser's built-in validation API
                const inputs = currentStepEl.querySelectorAll('input:required, select:required');
                let firstInvalid = null;
                let isValid = true;

                inputs.forEach(input => {
                    // Also check custom validation for number inputs with step="0.01" if needed,
                    // although type="number" step="0.01" should handle basic decimal validation.
                    if (!input.checkValidity()) {
                        input.style.borderColor = '#ef4444'; // Red border for invalid
                        if (!firstInvalid) {
                            firstInvalid = input; // Track the first invalid element
                        }
                        isValid = false;
                    } else {
                        input.style.borderColor = '#d1d5db'; // Reset border if valid
                    }
                });


                if (!isValid) {
                     showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกข้อมูลในช่องสีแดง หรือเลือกค่าให้ถูกต้อง');
                     if (firstInvalid) {
                        // Attempt to focus, might not work if element is not visible
                        // but helps guide the user if it does.
                        // Check if focusable (visible) before trying to focus
                         const style = window.getComputedStyle(firstInvalid);
                         if (style.display !== 'none' && style.visibility !== 'hidden') {
                             firstInvalid.focus();
                             firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                         }
                     }
                }
                return isValid;
            }

            // --- Conditional UI ---

            function updateConditionalUI() {
                const coopTypeEl = document.getElementById('coop_type');
                coopType = coopTypeEl.value;
                const d1_3_section = document.getElementById('d1_3_section');

                if (coopType === 'Ag') {
                    d1_3_section.style.display = 'block';
                } else {
                    d1_3_section.style.display = 'none';
                     // Clear checkboxes if switching away from Ag to avoid carrying over data
                     const checkboxes = document.querySelectorAll('input[name="d1_3_biz_types"]');
                     checkboxes.forEach(cb => cb.checked = false);
                }
            }

            // --- Data Gathering ---

            function gatherFormData() {
                const data = new FormData(form);
                formData = {};
                for (let [key, value] of data.entries()) {
                     // Handle number inputs specifically to ensure they are parsed correctly
                    const el = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                     if (el && el.type === 'number') {
                         formData[key] = value === '' ? null : parseFloat(value); // Store null if empty, otherwise parse as float
                     } else if (key === 'd1_3_biz_types') {
                         if (!formData[key]) {
                            formData[key] = [];
                        }
                        formData[key].push(value); // Checkbox values are pushed
                    } else if (el && el.type === 'checkbox') {
                         // This is handled manually below, skip here
                         continue;
                    }
                     else {
                         formData[key] = value;
                    }
                }

                // Manually gather ALL checkboxes (including unchecked ones for 1.2)
                const allCheckboxes = form.querySelectorAll('input[type="checkbox"]');
                 allCheckboxes.forEach(cb => {
                    // Only overwrite if it wasn't handled by FormData (like d1_3_biz_types)
                     if (!(cb.name === 'd1_3_biz_types' && formData[cb.name])) {
                        formData[cb.id || cb.name] = cb.checked;
                     }
                 });

                 // Ensure d1_3_biz_types is an empty array if no boxes were checked and it's Ag type
                 if(formData['coop_type'] === 'Ag' && !formData['d1_3_biz_types']) {
                     formData['d1_3_biz_types'] = [];
                 }


                // Store coop type from step 1
                formData['coop_type'] = document.getElementById('coop_type').value;
                formData['fiscal_year_end_date'] = document.getElementById('fiscal_year_end_date').value;

                console.log("Form Data Gathered:", formData);
            }

            // --- Calculation Engine ---

            // Show spinner on button
            function showSpinner(buttonId, show = true) {
                const btn = document.getElementById(buttonId);
                if (!btn) return; // Add check if button exists
                const spinner = btn.querySelector('.spinner');
                const icon = btn.querySelector('.icon');
                const text = btn.querySelector('.text');
                 if (show) {
                     if(spinner) spinner.classList.remove('hidden');
                     if (icon) icon.classList.add('hidden');
                     btn.disabled = true;
                     if(text) text.textContent = 'กรุณารอสักครู่...';
                 } else {
                     if(spinner) spinner.classList.add('hidden');
                     if (icon) icon.classList.remove('hidden');
                     btn.disabled = false;
                      if(text) text.textContent = buttonId === 'calculateBtn' ? 'คำนวณผล' : 'ส่งออกข้อมูล (Export)'; // Reset text
                 }
            }


            async function calculateScores() {
                 showSpinner('calculateBtn', true);
                 // Simulate calculation delay
                 await new Promise(resolve => setTimeout(resolve, 100)); // Reduced delay

                try {
                    gatherFormData();

                    scores = {
                        d1: calculateDimension1(),
                        d2: calculateDimension2(),
                        d3: calculateDimension3(),
                        d4: calculateDimension4(),
                    };

                    scores.total = (scores.d1.totalScore || 0) + (scores.d2.totalScore || 0) + (scores.d3.totalScore || 0) + (scores.d4.totalScore || 0);

                    console.log("Scores Calculated:", scores);

                    const classificationResult = runClassification();
                    showResults(classificationResult);
                 } catch (error) {
                     console.error("Calculation error:", error);
                     showCustomAlert('ข้อผิดพลาด', 'เกิดข้อผิดพลาดระหว่างการคำนวณ: ' + error.message);
                 } finally {
                     showSpinner('calculateBtn', false);
                 }
            }

            // --- Dimension 1 Calculation ---
            function calculateDimension1() {
                let totalScore = 0;
                let breakdown = {};
                const type = formData['coop_type'];

                // 1.1 สมาชิกมีส่วนร่วม (15 คะแนน)
                const totalMembers = formData['d1_1_total_members']; // Already parsed in gatherFormData
                const activeMembers = formData['d1_1_active_members'];
                let score_1_1 = 0;
                if (totalMembers !== null && totalMembers > 0) {
                    const ratio = (activeMembers / totalMembers) * 100;

                    // ใช้เกณฑ์ตามคู่มือ PDF หน้า 27
                    if (type === 'Ag') { // เกษตร, นิคม, ประมง
                        if (ratio > 80) score_1_1 = 15;
                        else if (ratio > 70) score_1_1 = 12;
                        else if (ratio > 60) score_1_1 = 9;
                        else score_1_1 = 6;
                    } else { // นอกภาคฯ
                        // Assume most NonAg types follow Ag rules, except Saving (ออมทรัพย์)
                        let th_high = 80, th_mid = 70, th_low = 60;
                        // Logic to check if it's Saving coop type would go here if we had more specific types
                        // For now, using the stricter Saving coop threshold from PDF p.27 for all NonAg
                         th_high = 85; th_mid = 80; th_low = 70; // Use Saving Coop threshold

                        if (ratio > th_high) score_1_1 = 15;
                        else if (ratio > th_mid) score_1_1 = 12;
                        else if (ratio > th_low) score_1_1 = 9;
                        else score_1_1 = 6;
                    }
                }
                breakdown['1.1'] = score_1_1;
                totalScore += score_1_1;

                // 1.2 ทุนสวัสดิการ 2 ปี (เกษตร 10, นอกภาค 15)
                const maxScore_1_2 = (type === 'Ag') ? 10 : 15;
                let score_1_2 = 0;

                const alloc_w_curr = formData['d1_2_welfare_allocated_current'];
                const pay_w_curr = formData['d1_2_welfare_paid_current'];
                const alloc_p_curr = formData['d1_2_public_allocated_current'];
                const pay_p_curr = formData['d1_2_public_paid_current'];
                const alloc_w_prev = formData['d1_2_welfare_allocated_prev'];
                const pay_w_prev = formData['d1_2_welfare_paid_prev'];
                const alloc_p_prev = formData['d1_2_public_allocated_prev'];
                const pay_p_prev = formData['d1_2_public_paid_prev'];

                // check 2 funds = welfare AND public
                const alloc_2_curr = alloc_w_curr && alloc_p_curr;
                const alloc_2_prev = alloc_w_prev && alloc_p_prev;
                const pay_2_curr = pay_w_curr && pay_p_curr;
                const pay_2_prev = pay_w_prev && pay_p_prev;
                const pay_1_curr = pay_w_curr || pay_p_curr; // จ่าย 1 ทุน (curr)
                const pay_1_prev = pay_w_prev || pay_p_prev; // จ่าย 1 ทุน (prev)

                const exception = formData['d4_2_exception'] === 'yes'; // ใช้ข้อยกเว้นจาก 4.2

                // เกณฑ์ PDF หน้า 26
                if (alloc_2_curr && alloc_2_prev && pay_2_curr && pay_2_prev) {
                    // ขั้นสูง: จัดสรร 2 ทุน (2 ปี) และ จ่าย 2 ทุน (2 ปี)
                    score_1_2 = maxScore_1_2; // 10 (Ag) or 15 (NonAg)
                } else if (alloc_2_curr && alloc_2_prev && ((pay_2_curr && pay_1_prev && !pay_2_prev) || (pay_2_prev && pay_1_curr && !pay_2_curr))) {
                    // ขั้นกลาง: จัดสรร 2 ทุน (2 ปี) และ (จ่าย 2 ทุน 1 ปี + จ่าย 1 ทุน 1 ปี)
                    score_1_2 = (type === 'Ag') ? 7 : 10;
                } else if ((alloc_2_curr && alloc_2_prev && (pay_2_curr || pay_2_prev)) ||
                           (alloc_2_curr && alloc_2_prev && (pay_1_curr && pay_1_prev)) ||
                           exception) {
                    // ขั้นต้น:
                    // 1. จัดสรร 2 ทุน (2 ปี) และ จ่าย 2 ทุน (1 ปี) [กรณีอีกปีไม่จ่ายเลย]
                    // 2. จัดสรร 2 ทุน (2 ปี) และ จ่าย 1 ทุน (2 ปี)
                    // 3. มีข้อยกเว้น
                    score_1_2 = (type === 'Ag') ? 4 : 5;
                } else {
                    // ขั้นเตรียม: อื่นๆ (ตามเงื่อนไขใน PDF หน้า 26)
                    // (1) ไม่จัดสรร/ไม่จ่าย ปีใดปีหนึ่ง หรือทั้ง 2 ปี
                    // (2) จัดสรร 2 ทุน 2 ปี แต่ไม่จ่ายเลยทั้ง 2 ทุน 2 ปี
                    // (3) จ่าย 1 ทุน 1 ปี และไม่จ่ายอีก 1 ปี
                    score_1_2 = 0;
                }

                breakdown['1.2'] = score_1_2;
                totalScore += score_1_2;

                // 1.3 จำนวนประเภทธุรกิจ (เฉพาะภาคเกษตร 5 คะแนน)
                let score_1_3 = 0;
                if (type === 'Ag') {
                    const bizCount = formData['d1_3_biz_types'] ? formData['d1_3_biz_types'].length : 0;
                    if (bizCount >= 6) score_1_3 = 5;
                    else if (bizCount >= 4) score_1_3 = 3; // 4-5 types
                    else if (bizCount >= 2) score_1_3 = 1; // 2-3 types
                    else score_1_3 = 0; // < 2 types
                }
                breakdown['1.3'] = score_1_3;
                totalScore += score_1_3;

                return { totalScore, breakdown };
            }

            // --- Dimension 2 Calculation ---
            function calculateDimension2() {
                 let totalScore = 0;
                 let breakdown = {};
                 const type = formData['coop_type'];
                 // Thresholds defined within the IIFE scope, accessible here
                 const thresholds = {
                    '2.1': { 'Ag': [0.75, 0.75, 1.75], 'NonAg': [0.50, 0.50, 1.00], dir: -1 },
                    '2.2': { 'Ag': [0.20, 0.10, 0.10], 'NonAg': [0.10, 0.04, 0.04], dir: 1 },
                    '2.3': { 'Ag': [3.00, 1.50, 1.50], 'NonAg': [4.00, 2.00, 2.00], dir: 1 },
                    '2.4': { 'Ag': [45, 65, 65],    'NonAg': [25, 35, 35],    dir: -1 },
                    '2.5': { 'Ag': [1.75, 0.75, 0.75], 'NonAg': [1.00, 0.50, 0.50], dir: 1 },
                    '2.6': { 'Ag': [90, 60, 60],    'NonAg': [95, 85, 85],    dir: 1 }
                };

                 let weights = { '2.1': 3, '2.2': 2, '2.3': 4, '2.4': 4, '2.5': 3, '2.6': 4 };

                // Get raw values (already parsed floats or null)
                 const v_total_debt = formData['d2_raw_total_debt'];
                 const v_total_capital = formData['d2_raw_total_capital'];
                 const v_reserve_fund = formData['d2_raw_reserve_fund'];
                 const v_assets_current = formData['d2_raw_assets_current'];
                 const v_assets_prev = formData['d2_raw_assets_prev'];
                 const v_op_profit = formData['d2_raw_operating_profit'];
                 const v_op_expense = formData['d2_raw_operating_expense'];
                 const v_profit_before_exp = formData['d2_raw_profit_before_expense'];
                 const v_current_assets = formData['d2_raw_current_assets'];
                 const v_current_liab = formData['d2_raw_current_liabilities'];
                 const v_debt_paid = formData['d2_raw_short_term_debt_paid'];
                 const v_debt_due = formData['d2_raw_short_term_debt_due'];

                 // Calculate Ratios
                 const r_2_1 = (v_total_capital !== null && v_total_capital > 0) ? (v_total_debt / v_total_capital) : null;
                 const r_2_2 = (v_assets_current !== null && v_assets_current > 0) ? (v_reserve_fund / v_assets_current) : null;
                 const v_assets_avg = (v_assets_current !== null && v_assets_prev !== null) ? (v_assets_current + v_assets_prev) / 2 : null;
                 const r_2_3 = (v_assets_avg !== null && v_assets_avg > 0) ? (v_op_profit / v_assets_avg) * 100 : null;
                 const r_2_4 = (v_profit_before_exp !== null && v_profit_before_exp > 0) ? (v_op_expense / v_profit_before_exp) * 100 : null;
                 const r_2_5 = (v_current_liab !== null && v_current_liab > 0) ? (v_current_assets / v_current_liab) : null;
                 const r_2_6 = (v_debt_due !== null && v_debt_due > 0) ? (v_debt_paid / v_debt_due) * 100 : null;


                // Calculate Standard Scores and Weighted Scores using helpers defined in IIFE scope
                 // 2.1
                 let std_2_1 = (r_2_1 === null || v_total_capital <= 0) ? 0 : getStdScore(r_2_1, thresholds['2.1'][type], thresholds['2.1'].dir);
                 let score_2_1 = getWeightedScore(std_2_1, weights['2.1']);
                 breakdown['2.1'] = score_2_1;
                 totalScore += score_2_1;

                 // 2.2
                 let std_2_2 = (r_2_2 === null || v_reserve_fund === 0) ? 0 : getStdScore(r_2_2, thresholds['2.2'][type], thresholds['2.2'].dir);
                 let score_2_2 = getWeightedScore(std_2_2, weights['2.2']);
                 breakdown['2.2'] = score_2_2;
                 totalScore += score_2_2;

                 // 2.3
                 let std_2_3 = (r_2_3 === null || v_op_profit <= 0) ? 0 : getStdScore(r_2_3, thresholds['2.3'][type], thresholds['2.3'].dir);
                 let score_2_3 = getWeightedScore(std_2_3, weights['2.3']);
                 breakdown['2.3'] = score_2_3;
                 totalScore += score_2_3;

                 // 2.4
                 let std_2_4 = (r_2_4 === null || v_profit_before_exp <= 0) ? 0 : getStdScore(r_2_4, thresholds['2.4'][type], thresholds['2.4'].dir);
                 let score_2_4 = getWeightedScore(std_2_4, weights['2.4']);
                 breakdown['2.4'] = score_2_4;
                 totalScore += score_2_4;


                // 2.5 & 2.6 (Handle Exception)
                 let std_2_5 = (r_2_5 === null) ? 0 : getStdScore(r_2_5, thresholds['2.5'][type], thresholds['2.5'].dir);
                 let score_2_5 = 0;
                 let score_2_6 = 0;
                 let temp_weight_2_5 = weights['2.5']; // Store original weight

                 if (formData['d2_raw_has_short_term_loan_biz'] === 'no') {
                     // Exception: โอนคะแนน 2.6 (4) ไป 2.5 (3) -> 2.5 มีน้ำหนัก 7
                     temp_weight_2_5 = 7; // Use temporary weight for calculation
                     score_2_5 = getWeightedScore(std_2_5, temp_weight_2_5);
                     score_2_6 = 0;
                     breakdown['2.6'] = 0; // Explicitly set 2.6 score to 0
                 } else {
                     // Normal case
                     score_2_5 = getWeightedScore(std_2_5, temp_weight_2_5); // Use original weight

                     let std_2_6 = (r_2_6 === null || (v_debt_paid === 0 && v_debt_due > 0)) ? 0 : getStdScore(r_2_6, thresholds['2.6'][type], thresholds['2.6'].dir);
                     score_2_6 = getWeightedScore(std_2_6, weights['2.6']);
                     breakdown['2.6'] = score_2_6;
                 }

                 breakdown['2.5'] = score_2_5;
                 totalScore += score_2_5 + score_2_6;

                 return { totalScore, breakdown };
             }

            // --- Dimension 3 Calculation ---
            function calculateDimension3() {
                let totalScore = 0;
                let breakdown = {};

                // 3.1 เทคโนโลยีการบัญชี (4 คะแนน) - คะแนนตรง
                const score_3_1 = parseFloat(formData['d3_1_status']); // Value is 4, 2, or 0
                breakdown['3.1'] = score_3_1;
                totalScore += score_3_1;

                // 3.2 - 3.5 การควบคุมภายใน (ตัวละ 4 คะแนน, ถ่วงน้ำหนัก)
                 // Standard scores are directly from the select options (3, 2, 1, 0)
                 const std_3_2 = parseFloat(formData['d3_2_status']);
                 const std_3_3 = parseFloat(formData['d3_3_status']);
                 const std_3_4 = parseFloat(formData['d3_4_status']);
                 const std_3_5 = parseFloat(formData['d3_5_status']);

                // Use the weighted score helper (now accessible)
                 const score_3_2 = getWeightedScore(std_3_2, 4); // Weight is 4
                 const score_3_3 = getWeightedScore(std_3_3, 4);
                 const score_3_4 = getWeightedScore(std_3_4, 4);
                 const score_3_5 = getWeightedScore(std_3_5, 4);

                 breakdown['3.2'] = score_3_2;
                 breakdown['3.3'] = score_3_3;
                 breakdown['3.4'] = score_3_4;
                 breakdown['3.5'] = score_3_5;

                 totalScore += score_3_2 + score_3_3 + score_3_4 + score_3_5;


                return { totalScore, breakdown };
            }

            // --- Dimension 4 Calculation ---
            function calculateDimension4() {
                 let totalScore = 0;
                 let breakdown = {};

                 // 4.1 ข้อบกพร่อง/ทุจริต (15 คะแนน) - คะแนนตรงจาก select value
                 const score_4_1 = parseFloat(formData['d4_1_status']);
                 breakdown['4.1'] = score_4_1;
                 totalScore += score_4_1;

                 // 4.2 ผลประกอบการ 2 ปี (5 คะแนน)
                 const profit_curr = formData['d4_2_profit_current_year']; // Already parsed
                 const profit_prev = formData['d4_2_profit_prev_year'];
                 const exception = formData['d4_2_exception'] === 'yes';
                 let score_4_2 = 0;

                 // Check for null before comparison
                 const curr_is_profit = profit_curr !== null && profit_curr > 0;
                 const prev_is_profit = profit_prev !== null && profit_prev > 0;
                 const curr_is_loss = profit_curr !== null && profit_curr <= 0;
                 const prev_is_loss = profit_prev !== null && profit_prev <= 0;


                 if (curr_is_profit && prev_is_profit) score_4_2 = 5; // ขั้นสูง: กำไร/กำไร
                 else if (curr_is_profit && prev_is_loss) score_4_2 = 3; // ขั้นกลาง: ขาดทุน/กำไร
                 else if (exception || (curr_is_loss && prev_is_profit)) score_4_2 = 1; // ขั้นต้น: กำไร/ขาดทุน หรือ มีข้อยกเว้น
                 else score_4_2 = 0; // ขั้นเตรียม: ขาดทุน/ขาดทุน (ไม่มีข้อยกเว้น)

                 breakdown['4.2'] = score_4_2;
                 totalScore += score_4_2;


                // 4.3 งบการเงินและอนุมัติ (5 คะแนน)
                let score_4_3 = 0;
                const endDate = formData['fiscal_year_end_date'] ? new Date(formData['fiscal_year_end_date']) : null;
                const sendDate = formData['d4_3_send_date'] ? new Date(formData['d4_3_send_date']) : null;
                const approveDate = formData['d4_3_approve_date'] ? new Date(formData['d4_3_approve_date']) : null;
                 let daysToApprove = Infinity;
                 let daysToSend = Infinity;


                if (endDate && approveDate) {
                     daysToApprove = (approveDate - endDate) / (1000 * 60 * 60 * 24);
                }
                 if(endDate && sendDate) {
                     daysToSend = (sendDate - endDate) / (1000 * 60 * 60 * 24);
                 }


                 const approved_within_150 = daysToApprove <= 150;
                 const send_within_30 = daysToSend <= 30;
                 const send_within_60 = daysToSend <= 60;
                 const send_within_90 = daysToSend <= 90;

                 if (approved_within_150 && send_within_30) score_4_3 = 5; // ขั้นสูง
                 else if (approved_within_150 && send_within_60) score_4_3 = 4; // ขั้นกลาง
                 else if (approved_within_150 && send_within_90) score_4_3 = 2; // ขั้นต้น
                 else if (!approved_within_150 && send_within_90) score_4_3 = 1; // ขั้นเตรียม (1)
                 else score_4_3 = 0; // ขั้นเตรียม (2), (3), (4 - covered by base condition check)

                 breakdown['4.3'] = score_4_3;
                 totalScore += score_4_3;


                 // 4.4 เจ้าหน้าที่ประจำ (5 คะแนน) - คะแนนตรงจาก select value
                 const score_4_4 = parseFloat(formData['d4_4_status']);
                 breakdown['4.4'] = score_4_4;
                 totalScore += score_4_4;


                return { totalScore, breakdown };
            }

             // --- Classification Logic (ตาม PPT) ---

             function runClassification() {
                 // Check if scores object exists
                 if (!scores || !scores.total || !scores.d4 || !scores.d4.breakdown) {
                    console.error("Scores not calculated properly.");
                    throw new Error("Calculation failed before classification."); // Stop execution
                 }
                 const totalScore = scores.total;
                 const type = formData['coop_type'];
                 let conditionsBreakdown = {};

                 // --- ขั้นตอนที่ 1: ตรวจสอบเงื่อนไขพื้นฐาน (Fundamental Conditions) ---
                 const cond_1_closed_books = formData['d_base_books_closed'] === 'yes';
                 const cond_2_meeting_held = formData['d_base_meeting_held'] === 'yes';

                 const endDate = formData['fiscal_year_end_date'] ? new Date(formData['fiscal_year_end_date']) : null;
                 const approveDate = formData['d4_3_approve_date'] ? new Date(formData['d4_3_approve_date']) : null;
                 let daysToApprove = Infinity;
                  if (endDate && approveDate) {
                     daysToApprove = (approveDate - endDate) / (1000 * 60 * 60 * 24);
                 }
                 const cond_3_approved_150 = daysToApprove <= 150;


                 conditionsBreakdown['1. ปิดบัญชีได้'] = { pass: cond_1_closed_books, 'value': cond_1_closed_books ? 'ผ่าน' : 'ไม่ผ่าน' };
                 conditionsBreakdown['2. ประชุมใหญ่ได้'] = { pass: cond_2_meeting_held, 'value': cond_2_meeting_held ? 'ผ่าน' : 'ไม่ผ่าน' };
                 conditionsBreakdown['3. อนุมัติงบฯ ภายใน 150 วัน'] = { pass: cond_3_approved_150, 'value': cond_3_approved_150 ? `ผ่าน (${daysToApprove <= 3650 ? daysToApprove.toFixed(0) : '-'} วัน)` : `ไม่ผ่าน (${daysToApprove <= 3650 ? daysToApprove.toFixed(0) : '-'} วัน)` };

                 const passes_fundamental = cond_1_closed_books && cond_2_meeting_held && cond_3_approved_150;

                 if (!passes_fundamental) {
                     return { 'class': 3, 'name': 'ต้องพัฒนา', 'reason': 'ไม่ผ่านเงื่อนไขพื้นฐาน (การปิดบัญชี/ประชุมใหญ่/อนุมัติงบฯ 150 วัน)', 'conditions': conditionsBreakdown };
                 }

                 // --- ขั้นตอนที่ 2: ตรวจสอบช่วงคะแนนรวม (Score Range Check) ---
                 const minScoreClass2 = (type === 'Ag') ? 55 : 65;

                 if (totalScore < minScoreClass2) {
                      return { 'class': 3, 'name': 'ต้องพัฒนา', 'reason': `ผ่านเงื่อนไขพื้นฐาน แต่คะแนนรวม (${totalScore.toFixed(2)}) ไม่ถึงเกณฑ์ ${minScoreClass2} คะแนน`, 'conditions': conditionsBreakdown };
                 }

                 // --- ขั้นตอนที่ 3: ตรวจสอบเงื่อนไขสำคัญ (Important Conditions) ---
                 const score_4_1 = scores.d4.breakdown['4.1']; // คะแนน 15, 10, 5, 0
                 const score_4_2 = scores.d4.breakdown['4.2']; // คะแนน 5, 3, 1, 0

                 // เงื่อนไขชั้น 1 (PPT หน้า 16, 20)
                 const cond_class1_profit = (score_4_2 === 5); // ไม่ขาดทุน 2 ปี (ได้ 5 คะแนน)
                 const cond_class1_defect = (score_4_1 === 15); // แก้ไขเสร็จสมบูรณ์ (ได้ 15 คะแนน)
                 const passes_class1_conditions = cond_class1_profit && cond_class1_defect;

                 conditionsBreakdown['4. (ชั้น 1) ไม่ขาดทุน 2 ปี (4.2=5)'] = { pass: cond_class1_profit, 'value': cond_class1_profit ? 'ผ่าน' : `ไม่ผ่าน (ได้ ${score_4_2} คะแนน)` };
                 conditionsBreakdown['5. (ชั้น 1) ข้อบกพร่องเสร็จสมบูรณ์ (4.1=15)'] = { pass: cond_class1_defect, 'value': cond_class1_defect ? 'ผ่าน' : `ไม่ผ่าน (ได้ ${score_4_1} คะแนน)` };

                 // เงื่อนไขชั้น 2 (PPT หน้า 16, 20)
                 const cond_class2_profit = (score_4_2 >= 3); // ไม่ขาดทุนปีปัจจุบัน (ได้ 3 หรือ 5 คะแนน)
                 const cond_class2_defect = (score_4_1 >= 10); // เสร็จต้องติดตาม หรือดีกว่า (ได้ 10 หรือ 15 คะแนน)
                 const passes_class2_conditions = cond_class2_profit && cond_class2_defect;

                 conditionsBreakdown['6. (ชั้น 2) ไม่ขาดทุนปีปัจจุบัน (4.2>=3)'] = { pass: cond_class2_profit, 'value': cond_class2_profit ? 'ผ่าน' : `ไม่ผ่าน (ได้ ${score_4_2} คะแนน)` };
                 conditionsBreakdown['7. (ชั้น 2) ข้อบกพร่องเสร็จต้องติดตาม (4.1>=10)'] = { pass: cond_class2_defect, 'value': cond_class2_defect ? 'ผ่าน' : `ไม่ผ่าน (ได้ ${score_4_1} คะแนน)` };


                 // --- ตรรกะการจัดชั้นสุดท้าย (Final Logic) ---
                 if (totalScore >= 80 && passes_class1_conditions) {
                     return { 'class': 1, 'name': 'เข้มแข็ง', 'reason': `คะแนน ${totalScore.toFixed(2)} (>= 80) และผ่านเงื่อนไขสำคัญชั้น 1`, 'conditions': conditionsBreakdown };
                 }

                 if (passes_class2_conditions) {
                     // กรณี: 1. คะแนน >= 80 แต่ตกเงื่อนไขชั้น 1 -> ได้ชั้น 2
                     // กรณี: 2. คะแนน < 80 (แต่ >= เกณฑ์ขั้นต่ำ 55/65) -> ได้ชั้น 2
                      let reasonClass2 = `คะแนน ${totalScore.toFixed(2)} และผ่านเงื่อนไขสำคัญชั้น 2`;
                      if (totalScore >= 80 && !passes_class1_conditions) {
                          reasonClass2 += " (แต่ไม่ผ่านเงื่อนไขสำคัญชั้น 1)";
                      }
                     return { 'class': 2, 'name': 'เข้มแข็ง', 'reason': reasonClass2, 'conditions': conditionsBreakdown };
                 }

                 // กรณี: ผ่านเงื่อนไขพื้นฐาน, ผ่านเกณฑ์คะแนน (>=55 หรือ >=65) แต่ "ไม่ผ่านเงื่อนไขสำคัญชั้น 2"
                 return { 'class': 3, 'name': 'ต้องพัฒนา', 'reason': `ผ่านเกณฑ์คะแนน (${totalScore.toFixed(2)}) แต่ไม่ผ่านเงื่อนไขสำคัญชั้น 2 (ตชว 4.1 หรือ 4.2)`, 'conditions': conditionsBreakdown };
             }


            // --- Show Results Modal ---

            function showResults(result) {
                // Main classification
                document.getElementById('finalClassDisplay').textContent = `ชั้น ${result.class}`;
                document.getElementById('finalClassName').textContent = result.name;
                document.getElementById('finalClassReason').textContent = result.reason;

                const classDisplay = document.getElementById('finalClassDisplay');
                classDisplay.classList.remove('text-blue-600', 'text-green-600', 'text-red-600');
                if (result.class === 1) classDisplay.classList.add('text-blue-600');
                else if (result.class === 2) classDisplay.classList.add('text-green-600');
                else classDisplay.classList.add('text-red-600');

                // Score summary
                document.getElementById('totalScoreDisplay').textContent = `${scores.total.toFixed(2)} / 100`;
                // Correct max score for D1 display
                const maxD1Score = 30.00; // D1 is 30 points for both types
                document.getElementById('d1ScoreDisplay').textContent = `${scores.d1.totalScore.toFixed(2)} / ${maxD1Score.toFixed(2)}`;
                document.getElementById('d2ScoreDisplay').textContent = `${scores.d2.totalScore.toFixed(2)} / 20.00`;
                document.getElementById('d3ScoreDisplay').textContent = `${scores.d3.totalScore.toFixed(2)} / 20.00`;
                document.getElementById('d4ScoreDisplay').textContent = `${scores.d4.totalScore.toFixed(2)} / 30.00`;

                 // Detailed breakdown - Now displays rounded scores
                 const breakdownEl = document.getElementById('detailedBreakdown');
                 breakdownEl.innerHTML = `
                     <strong>มิติที่ 1:</strong>
                     1.1 = ${scores.d1.breakdown['1.1'].toFixed(2)};
                     1.2 = ${scores.d1.breakdown['1.2'].toFixed(2)};
                     1.3 = ${scores.d1.breakdown['1.3'].toFixed(2)}
                     <br>
                     <strong>มิติที่ 2:</strong>
                     2.1 = ${scores.d2.breakdown['2.1'].toFixed(2)};
                     2.2 = ${scores.d2.breakdown['2.2'].toFixed(2)};
                     2.3 = ${scores.d2.breakdown['2.3'].toFixed(2)};
                     2.4 = ${scores.d2.breakdown['2.4'].toFixed(2)};
                     2.5 = ${scores.d2.breakdown['2.5'].toFixed(2)};
                     2.6 = ${scores.d2.breakdown['2.6'].toFixed(2)}
                     <br>
                     <strong>มิติที่ 3:</strong>
                     3.1 = ${scores.d3.breakdown['3.1'].toFixed(2)};
                     3.2 = ${scores.d3.breakdown['3.2'].toFixed(2)};
                     3.3 = ${scores.d3.breakdown['3.3'].toFixed(2)};
                     3.4 = ${scores.d3.breakdown['3.4'].toFixed(2)};
                     3.5 = ${scores.d3.breakdown['3.5'].toFixed(2)}
                     <br>
                     <strong>มิติที่ 4:</strong>
                     4.1 = ${scores.d4.breakdown['4.1'].toFixed(2)};
                     4.2 = ${scores.d4.breakdown['4.2'].toFixed(2)};
                     4.3 = ${scores.d4.breakdown['4.3'].toFixed(2)};
                     4.4 = ${scores.d4.breakdown['4.4'].toFixed(2)}
                 `;


                // Conditions breakdown
                const conditionsEl = document.getElementById('conditionsBreakdown');
                conditionsEl.innerHTML = '';
                for (const [key, value] of Object.entries(result.conditions)) {
                    const pass = value.pass;
                    const text = value.value;
                    const color = pass ? 'text-green-600' : 'text-red-600';
                    const icon = pass ? '✓' : '✗';
                    conditionsEl.innerHTML += `<div class="${color} font-medium">${icon} ${key}: ${text}</div>`;
                }

                resultsModal.classList.add('active');
            }

            // --- Alert Modal Functionality ---
             function showCustomAlert(title = "แจ้งเตือน", message = "") {
                 alertModalTitle.textContent = title;
                 alertModalMessage.textContent = message;
                 alertModal.classList.add('active');
                 alertModalOkBtn.focus(); // Focus OK button
             }

             function hideAlertModal() {
                 alertModal.classList.remove('active');
             }


            // --- Import/Export ---

             async function exportData() {
                 showSpinner('exportBtn', true);
                  // Simulate export delay
                 await new Promise(resolve => setTimeout(resolve, 300));

                try {
                    gatherFormData(); // Ensure formData is up-to-date
                    const dataStr = JSON.stringify(formData, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

                    const exportFileDefaultName = 'scm_data.json';

                    let linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    linkElement.remove(); // Clean up the link element

                    // Use timeout to ensure file download dialog appears before showing alert
                    setTimeout(() => {
                         showCustomAlert('ส่งออกสำเร็จ', 'ข้อมูลถูกส่งออกเป็นไฟล์ scm_data.json เรียบร้อยแล้ว');
                     }, 100); // Small delay


                 } catch (error) {
                      console.error("Export error:", error);
                      showCustomAlert('ส่งออกล้มเหลว', 'เกิดข้อผิดพลาดในการส่งออกข้อมูล: ' + error.message);
                 } finally {
                     showSpinner('exportBtn', false);
                 }
            }

            function importData() {
                 // Clear previous selection to allow re-importing the same file
                 fileInput.value = null;
                 fileInput.click();
            }

            function loadData(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);

                        // Populate form fields
                        for (const [key, value] of Object.entries(data)) {
                             const elements = form.elements[key]; // More robust way to find elements

                             if (!elements) continue; // Skip if no element found

                             // Handle NodeList (radio buttons) vs single element
                             const elementList = elements.length ? Array.from(elements) : [elements];

                             elementList.forEach(el => {
                                 if (el.type === 'checkbox') {
                                     // Handle single checkbox or group (like d1_3_biz_types)
                                     if (Array.isArray(value)) { // Group like d1_3
                                         el.checked = value.includes(el.value);
                                     } else { // Single checkbox like d1_2
                                         el.checked = !!value; // Ensure boolean
                                     }
                                 } else if (el.type === 'radio') {
                                     if (el.value === value) {
                                         el.checked = true;
                                     }
                                 } else if (el.tagName === 'SELECT') {
                                      el.value = value;
                                 } else if (el.type === 'date') {
                                      // Ensure date format is YYYY-MM-DD
                                      el.value = value ? value.split('T')[0] : '';
                                 } else {
                                     // Handle text, number inputs
                                     el.value = (value === null || value === undefined) ? '' : value; // Set to empty string if null/undefined
                                 }
                             });
                        }


                        // After loading, update UI and move to first step
                        updateConditionalUI(); // Update visibility based on coop type
                        currentStep = 1;
                        showStep(currentStep);
                        console.log("Data imported successfully.");
                        showCustomAlert('นำเข้าสำเร็จ', 'ข้อมูลถูกนำเข้าเรียบร้อยแล้ว');

                    } catch (err) {
                        console.error("Error parsing JSON file:", err);
                        showCustomAlert('นำเข้าข้อมูลล้มเหลว', 'ไฟล์ JSON ไม่ถูกต้องหรือไม่สามารถอ่านได้: ' + err.message);
                    }
                };
                 reader.onerror = function() {
                      console.error("Error reading file");
                      showCustomAlert('นำเข้าข้อมูลล้มเหลว', 'ไม่สามารถอ่านไฟล์ได้');
                 };
                reader.readAsText(file);

            }

            // --- Event Listeners ---

            document.addEventListener('DOMContentLoaded', () => {
                showStep(currentStep);

                // Navigation
                prevBtn.addEventListener('click', prevStep);
                nextBtn.addEventListener('click', nextStep);

                // Form Submission
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    clearValidationErrors(totalSteps); // Clear previous errors
                    if (validateStep(totalSteps)) {
                        await calculateScores(); // Make it async
                    }
                });

                // Results Modal Close
                modalCloseBtnResults.addEventListener('click', () => resultsModal.classList.remove('active'));
                 resultsModal.addEventListener('click', (e) => {
                     if (e.target === resultsModal) {
                         resultsModal.classList.remove('active');
                     }
                 });


                 // Alert Modal Close Listeners
                 alertModalCloseBtn.addEventListener('click', hideAlertModal);
                 alertModalOkBtn.addEventListener('click', hideAlertModal);
                 alertModal.addEventListener('click', (e) => {
                     if (e.target === alertModal) {
                         hideAlertModal();
                     }
                 });


                // Conditional UI
                document.getElementById('coop_type').addEventListener('change', updateConditionalUI);

                // Import/Export
                importBtn.addEventListener('click', importData);
                exportBtn.addEventListener('click', exportData);
                fileInput.addEventListener('change', loadData);

                // Add input event listeners to clear validation border on input
                 const allInputs = form.querySelectorAll('input, select');
                 allInputs.forEach(input => {
                     input.addEventListener('input', () => {
                         if (input.checkValidity()) {
                             input.style.borderColor = '#d1d5db';
                         }
                     });
                     // For selects, 'change' event is more appropriate
                     if(input.tagName === 'SELECT') {
                         input.addEventListener('change', () => {
                             if (input.checkValidity()) {
                                 input.style.borderColor = '#d1d5db';
                             }
                         });
                     }
                 });
            });

        })();
    </script>
</body>
</html>

