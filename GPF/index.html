<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPF NAV Analysis Tool</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- 3. PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .input-toggle:not(:checked) + div {
            display: none;
        }
        .tab-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">

</head>
<body class="bg-gray-100 text-gray-800 flex" style="font-family: 'Sarabun', 'Inter', sans-serif;">

    <!-- ==== 1. SIDEBAR (‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°) ==== -->
    <aside class="fixed top-0 left-0 w-80 h-full bg-white shadow-lg p-6 overflow-y-auto">
        <h1 class="text-2xl font-bold text-blue-600 mb-6">GPF Analysis Tool üìà</h1>

        <!-- 1.1 ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
        <section class="mb-6">
            <h2 class="text-lg font-semibold mb-3 text-gray-700">1. ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• NAV</h2>
            
            <div class="flex space-x-4 mb-3">
                <label class="flex items-center">
                    <input type="radio" name="importType" class="input-toggle" value="file" checked>
                    <span class="ml-2 text-sm">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="importType" class="input-toggle" value="gsheet">
                    <span class="ml-2 text-sm">Google Sheet</span>
                </label>
            </div>

            <div id="file-input-group">
                <input type="file" id="csv-file-input" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" accept=".csv">
                
                <!-- (NEW) Encoding Selector -->
                <label for="encoding-select" class="text-xs text-gray-500 mt-2 block">Encoding:</label>
                <select id="encoding-select" class="w-full text-sm p-1 border border-gray-300 rounded-lg">
                    <option value="UTF-8">UTF-8 (Default)</option>
                    <option value="windows-874">TIS-620 / Windows (Thai)</option>
                </select>
            </div>

            <div id="gsheet-input-group" class="hidden">
                <input type="text" id="gsheet-url-input" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheet" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                <p class="text-xs text-gray-500 mt-1">‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà "‡πÅ‡∏ä‡∏£‡πå" ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ</p>
            </div>
            
            <button id="load-data-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 mt-4">
                ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>

            <div class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg text-xs text-gray-600">
                <h4 class="font-semibold mb-1">‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤:</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li>‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏Ñ‡∏∑‡∏≠ "Header" (Date, ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô, ...)</li>
                    <li>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å‡∏Ñ‡∏∑‡∏≠ "Date" (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy)</li>
                    <li>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Ñ‡∏∑‡∏≠ NAV ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</li>
                </ul>
            </div>
        </section>

        <!-- 1.2 ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå -->
        <section class="mb-6">
            <h2 class="text-lg font-semibold mb-3 text-gray-700">2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå</h2>
            <div class="space-y-3">
                <div>
                    <label for="short-ma" class="block text-sm font-medium text-gray-600">MA ‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô (‡∏ß‡∏±‡∏ô)</label>
                    <input type="number" id="short-ma" value="50" class="w-full p-2 border border-gray-300 rounded-lg mt-1 text-sm">
                </div>
                <div>
                    <label for="long-ma" class="block text-sm font-medium text-gray-600">MA ‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß (‡∏ß‡∏±‡∏ô)</label>
                    <input type="number" id="long-ma" value="200" class="w-full p-2 border border-gray-300 rounded-lg mt-1 text-sm">
                </div>
                <div>
                    <label for="rsi-period" class="block text-sm font-medium text-gray-600">RSI Period (‡∏ß‡∏±‡∏ô)</label>
                    <input type="number" id="rsi-period" value="14" class="w-full p-2 border border-gray-300 rounded-lg mt-1 text-sm">
                </div>
                <div>
                    <label for="vol-period" class="block text-sm font-medium text-gray-600">‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô (‡∏ß‡∏±‡∏ô)</label>
                    <input type="number" id="vol-period" value="50" class="w-full p-2 border border-gray-300 rounded-lg mt-1 text-sm">
                </div>
                <div>
                    <label for="switch-limit" class="block text-sm font-medium text-gray-600">‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö (‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏õ‡∏µ)</label>
                    <input type="number" id="switch-limit" value="12" class="w-full p-2 border border-gray-300 rounded-lg mt-1 text-sm" readonly>
                </div>
            </div>
        </section>

        <!-- 1.3 ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô -->
        <section>
            <h2 class="text-lg font-semibold mb-3 text-gray-700">3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)</h2>
            <div id="fund-selector" class="space-y-2 max-h-40 overflow-y-auto bg-gray-50 p-3 rounded-lg border">
                <p class="text-sm text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô...</p>
            </div>
        </section>

        <!-- 1.4 ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
        <section class="mt-6">
            <h2 class="text-lg font-semibold mb-3 text-gray-700">4. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
            <div class="space-y-3 bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div>
                    <label for="current-fund-select" class="block text-sm font-medium text-gray-600">‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà</label>
                    <select id="current-fund-select" class="w-full p-2 border border-gray-300 rounded-lg mt-1 text-sm">
                        <option value="">-- ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                    </select>
                </div>
                <div>
                    <label for="entry-date-input" class="block text-sm font-medium text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∏‡∏ô (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)</label>
                    <input type="date" id="entry-date-input" class="w-full p-2 border border-gray-300 rounded-lg mt-1 text-sm">
                </div>
            </div>
        </section>
        
        <button id="run-analysis-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-200 mt-6">
            ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
        </button>

        <div id="status-message" class="mt-4 text-sm"></div>
    </aside>

    <!-- ==== 2. MAIN CONTENT (‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•) ==== -->
    <main class="ml-80 w-[calc(100%-320px)] p-8">
        <div class="border-b border-gray-300 mb-6">
            <nav class="flex space-x-6">
                <button class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-600 hover:text-blue-600 active" data-tab="dashboard">
                    ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                </button>
                <button class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-600 hover:text-blue-600" data-tab="chart">
                    ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
                </button>
                <button class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-600 hover:text-blue-600" data-tab="backtest">
                    ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì
                </button>
                <button class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-600 hover:text-blue-600" data-tab="suggestion">
                    ‚≠ê ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
                </button>
            </nav>
        </div>

        <div id="tab-content">
            <!-- 2.2.1 ‡πÅ‡∏ó‡πá‡∏ö "‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" -->
            <div id="dashboard-content" class="tab-panel">
                <h2 class="text-2xl font-semibold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</h2>
                <div id="dashboard-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-gray-500">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"</p>
                </div>
            </div>

            <!-- 2.2.2 ‡πÅ‡∏ó‡πá‡∏ö "‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå" -->
            <div id="chart-content" class="tab-panel hidden">
                <h2 class="text-2xl font-semibold mb-4">‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå NAV</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <canvas id="nav-chart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                    <canvas id="rsi-chart"></canvas>
                </div>
            </div>

            <!-- 2.2.3 ‡πÅ‡∏ó‡πá‡∏ö "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì" (Backtest) -->
            <div id="backtest-content" class="tab-panel hidden">
                <h2 class="text-2xl font-semibold mb-4">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì (‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô)</h2>
                <p class="text-sm text-gray-600 mb-4">
                    ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏™‡∏•‡∏±‡∏ö (Golden/Death Cross) ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå
                </p>
                <div id="backtest-results" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                    <p class="text-gray-500">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"</p>
                </div>
            </div>

            <!-- 2.2.4 ‡πÅ‡∏ó‡πá‡∏ö "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥" -->
            <div id="suggestion-content" class="tab-panel hidden">
                <h2 class="text-2xl font-semibold mb-4">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
                <div id="suggestion-results" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                    <p class="text-gray-500">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà" ‡πÅ‡∏•‡∏∞ "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∏‡∏ô" ‡πÉ‡∏ô Sidebar (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"</p>
                </div>
            </div>
        </div>

        <footer class="text-center text-xs text-gray-500 mt-12">
            ¬© developed by Tle Narongphisit | CTTC19 CPD
        </footer>

    </main>

    <!-- ==== 3. JAVASCRIPT (REFACTORED) ==== -->
    <script>
        /**
         * GPF Analysis Tool - Refactored Module
         * ‡∏´‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏° Logic ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Object ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (GPFApp)
         * ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Global Scope Pollution ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î
         */
        const GPFApp = {
            // === 1. STATE ===
            // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô
            state: {
                fundsData: {},         // { "FundName": [{date, nav}, ...] }
                fundsDataMap: {},      // { "FundName": Map(dateString -> nav) }
                settings: {},          // { shortMA, longMA, rsiPeriod, ... }
                analysisResults: [],   // ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                masterTimeAxis: [],    // ‡πÅ‡∏Å‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
            },

            // === 2. DOM ELEMENTS ===
            // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á DOM ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢
            elements: {},

            // === 3. CHART INSTANCES ===
            // ‡πÄ‡∏Å‡πá‡∏ö Instance ‡∏Ç‡∏≠‡∏á Chart.js
            charts: {
                navChart: null,
                rsiChart: null
            },

            // === 4. INITIALIZATION ===
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à)
            init() {
                // 4.1. ‡∏ú‡∏π‡∏Å DOM Elements
                this.elements = {
                    loadDataBtn: document.getElementById('load-data-btn'),
                    runAnalysisBtn: document.getElementById('run-analysis-btn'),
                    fileInput: document.getElementById('csv-file-input'),
                    gsheetInput: document.getElementById('gsheet-url-input'),
                    fileInputGroup: document.getElementById('file-input-group'),
                    gsheetInputGroup: document.getElementById('gsheet-input-group'),
                    importTypeRadios: document.querySelectorAll('input[name="importType"]'),
                    fundSelectorDiv: document.getElementById('fund-selector'),
                    statusMessage: document.getElementById('status-message'),
                    shortMAInput: document.getElementById('short-ma'),
                    longMAInput: document.getElementById('long-ma'),
                    rsiPeriodInput: document.getElementById('rsi-period'),
                    volPeriodInput: document.getElementById('vol-period'),
                    switchLimitInput: document.getElementById('switch-limit'),
                    encodingSelect: document.getElementById('encoding-select'),
                    tabs: document.querySelectorAll('.tab-btn'),
                    tabPanels: document.querySelectorAll('.tab-panel'),
                    dashboardCardsDiv: document.getElementById('dashboard-cards'),
                    backtestResultsDiv: document.getElementById('backtest-results'),
                    suggestionResultsDiv: document.getElementById('suggestion-results'),
                    currentFundSelect: document.getElementById('current-fund-select'),
                    entryDateInput: document.getElementById('entry-date-input'),
                    navChartCanvas: document.getElementById('nav-chart'),
                    rsiChartCanvas: document.getElementById('rsi-chart')
                };

                // 4.2. ‡∏ú‡∏π‡∏Å Event Listeners
                // ‡πÉ‡∏ä‡πâ .bind(this) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ 'this' ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á GPFApp
                this.elements.importTypeRadios.forEach(radio => {
                    radio.addEventListener('change', this.handleImportTypeChange.bind(this));
                });
                this.elements.loadDataBtn.addEventListener('click', this.handleLoadData.bind(this));
                this.elements.runAnalysisBtn.addEventListener('click', this.handleRunAnalysis.bind(this));
                this.elements.tabs.forEach(tab => {
                    tab.addEventListener('click', this.handleTabClick.bind(this));
                });

                this.setStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'blue');
            },

            // === 5. EVENT HANDLERS ===
            
            handleImportTypeChange(e) {
                if (e.target.value === 'file') {
                    this.elements.fileInputGroup.style.display = 'block';
                    this.elements.gsheetInputGroup.style.display = 'none';
                } else {
                    this.elements.fileInputGroup.style.display = 'none';
                    this.elements.gsheetInputGroup.style.display = 'block';
                }
            },

            handleTabClick(e) {
                const targetTab = e.currentTarget.getAttribute('data-tab');
                
                this.elements.tabs.forEach(t => t.classList.remove('active'));
                e.currentTarget.classList.add('active');
                
                this.elements.tabPanels.forEach(panel => {
                    panel.style.display = (panel.id === `${targetTab}-content`) ? 'block' : 'none';
                });
            },

            handleLoadData() {
                const importType = document.querySelector('input[name="importType"]:checked').value;
                this.setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'blue');

                if (importType === 'file') {
                    const file = this.elements.fileInput.files[0];
                    if (!file) {
                        this.setStatus('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Å‡πà‡∏≠‡∏ô', 'red');
                        return;
                    }
                    this.parseCSV(file);
                } else {
                    const url = this.elements.gsheetInput.value.trim();
                    if (!url) {
                        this.setStatus('‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Sheet', 'red');
                        return;
                    }
                    this.loadFromGSheet(url);
                }
            },

            handleRunAnalysis() {
                // 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                this.updateSettings();
                const { selectedFunds } = this.state.settings;

                if (selectedFunds.length === 0) {
                    this.setStatus('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô', 'red');
                    return;
                }
                
                this.setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...', 'blue');

                // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á (Core Logic)
                this.performFullAnalysis();

                // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                this.renderAll();

                this.setStatus('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'green');
            },

            // === 6. DATA LOADING & PROCESSING ===
            
            loadFromGSheet(url) {
                const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                let csvUrl = url;
                if (match && match[1]) {
                    const sheetId = match[1];
                    // ‡πÉ‡∏ä‡πâ gid=0 (Sheet ‡πÅ‡∏£‡∏Å)
                    csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
                } else {
                    // ‡∏ñ‡πâ‡∏≤ URL ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà /d/sheetId... ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏£‡∏á‡πÜ
                    if (!url.includes('export?format=csv')) {
                         this.setStatus('URL Google Sheet ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏£‡πå)', 'red');
                         return;
                    }
                }

                Papa.parse(csvUrl, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        this.processData(results.data);
                    },
                    error: (err) => {
                        this.setStatus(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î GSheet: ${err.message}. (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á "‡πÅ‡∏ä‡∏£‡πå" ‡πÄ‡∏õ‡πá‡∏ô "‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå")`, 'red');
                    }
                });
            },
            
            parseCSV(file) {
                // (REFACTORED) Use FileReader to handle encoding explicitly
                const encoding = this.elements.encodingSelect.value;
                this.setStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå (Encoding: ${encoding})...`, 'blue');

                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const text = e.target.result;
                    // Now parse the string result
                    Papa.parse(text, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: true,
                        complete: (results) => {
                            this.processData(results.data);
                        },
                        error: (err) => {
                            this.setStatus(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå: ${err.message}`, 'red');
                        }
                    });
                };
                
                reader.onerror = (e) => {
                    this.setStatus(`File reading error: ${e.message}`, 'red');
                };

                // Read the file using the selected encoding
                reader.readAsText(file, encoding);
            },

            processData(data) {
                if (data.length === 0) {
                    this.setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'red');
                    return;
                }

                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏≠‡∏ô‡∏∏‡πÇ‡∏•‡∏°‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ)
                const headers = Object.keys(data[0]);
                const DATE_COL = headers.find(h => h.toLowerCase().includes('date'));
                
                if (!DATE_COL) {
                    this.setStatus(`‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô 'Date', 'date', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà')`, 'red');
                    return;
                }

                const fundNames = headers.filter(h => 
                    h !== DATE_COL && h.trim() !== "" && !h.toLowerCase().includes("‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á") && !h.toLowerCase().includes("‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏£‡∏≠‡∏á")
                );

                if (fundNames.length === 0) {
                    this.setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå', 'red');
                    return;
                }

                this.state.fundsData = {}; // Reset
                this.state.fundsDataMap = {}; // Reset
                fundNames.forEach(fundName => {
                    this.state.fundsData[fundName] = [];
                    this.state.fundsDataMap[fundName] = new Map();
                });

                data.forEach(row => {
                    const dateStr = row[DATE_COL];
                    let date = this.parseDate(dateStr);

                    if (isNaN(date) || !date) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

                    fundNames.forEach(fundName => {
                        let navStr = row[fundName];
                        if (typeof navStr === 'string') navStr = navStr.replace(/,/g, '');
                        const nav = parseFloat(navStr);

                        if (!isNaN(nav) && nav > 0) {
                            const dataPoint = { date, nav };
                            this.state.fundsData[fundName].push(dataPoint);
                            this.state.fundsDataMap[fundName].set(date.getTime(), dataPoint);
                        }
                    });
                });

                // Sort ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Array (‡πÄ‡∏Å‡πà‡∏≤ -> ‡πÉ‡∏´‡∏°‡πà)
                for (const fund in this.state.fundsData) {
                    this.state.fundsData[fund].sort((a, b) => a.date - b.date);
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Map ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ)
                    this.state.fundsDataMap[fund] = new Map([...this.state.fundsDataMap[fund].entries()].sort());
                }

                this.populateFundSelector();
                this.setStatus(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${Object.keys(this.state.fundsData).length} ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'green');
            },

            // === 7. CORE ANALYSIS (Refactored) ===
            
            // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å DOM ‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô State
            updateSettings() {
                this.state.settings = {
                    shortMA: parseInt(this.elements.shortMAInput.value),
                    longMA: parseInt(this.elements.longMAInput.value),
                    rsiPeriod: parseInt(this.elements.rsiPeriodInput.value),
                    volPeriod: parseInt(this.elements.volPeriodInput.value),
                    switchLimit: parseInt(this.elements.switchLimitInput.value),
                    selectedFunds: Array.from(document.querySelectorAll('.fund-checkbox:checked')).map(cb => cb.value),
                    heldFundName: this.elements.currentFundSelect.value,
                    entryDateStr: this.elements.entryDateInput.value
                };
            },

            // ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏´‡∏•‡∏±‡∏Å: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            performFullAnalysis() {
                this.state.analysisResults = []; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏Å‡πà‡∏≤
                this.state.masterTimeAxis = []; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏Å‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
                const { settings, fundsData, fundsDataMap } = this.state;
                
                // (NEW) ‡∏™‡∏£‡πâ‡∏≤‡∏á Master Time Axis ‡∏à‡∏≤‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const allTimestamps = new Set();
                settings.selectedFunds.forEach(fundName => {
                    // (FIX) ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ fundsData[fundName] ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
                    if (fundsData[fundName]) {
                        fundsData[fundName].forEach(dp => allTimestamps.add(dp.date.getTime()));
                    }
                });
                this.state.masterTimeAxis = Array.from(allTimestamps).sort((a, b) => a - b).map(ts => new Date(ts));
                const masterTimeStrings = this.state.masterTimeAxis.map(date => date.getTime());
                
                settings.selectedFunds.forEach(fundName => {
                    const data = fundsData[fundName];
                    const dataMap = fundsDataMap[fundName];

                    // (FIX) ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ data ‡πÅ‡∏•‡∏∞ dataMap ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
                    if (!data || !dataMap) {
                        console.warn(`‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô ${fundName} (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)`);
                        return;
                    }

                    if (data.length < settings.longMA) { // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ
                        console.warn(`‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô ${fundName} (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠)`);
                        return;
                    }
                    
                    // (NEW) ‡∏™‡∏£‡πâ‡∏≤‡∏á Series ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Master Axis
                    const alignedPrices = this.state.masterTimeAxis.map(date => dataMap.get(date.getTime())?.nav || null);
                    
                    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Indicators (‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° Series ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß)
                    // ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á data.map(d => d.nav) (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö) ‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πà‡∏≠‡∏ô
                    // ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ map ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏Å‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
                    
                    const prices = data.map(d => d.nav);
                    const dates = data.map(d => d.date);
                    
                    const smaShortSeries = this.calculateMA(prices, settings.shortMA);
                    const smaLongSeries = this.calculateMA(prices, settings.longMA);
                    const rsiSeries = this.calculateRSI(prices, settings.rsiPeriod);
                    const volSeries = this.calculateVolatility(prices, settings.volPeriod);

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map (Date -> Indicator Value) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á
                    const smaShortMap = new Map(dates.map((date, i) => [date.getTime(), smaShortSeries[i]]));
                    const smaLongMap = new Map(dates.map((date, i) => [date.getTime(), smaLongSeries[i]]));
                    const rsiMap = new Map(dates.map((date, i) => [date.getTime(), rsiSeries[i]]));

                    // (NEW) ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á Indicators ‡πÄ‡∏Ç‡πâ‡∏≤ Master Axis
                    const alignedSmaShort = masterTimeStrings.map(ts => smaShortMap.get(ts) || null);
                    const alignedSmaLong = masterTimeStrings.map(ts => smaLongMap.get(ts) || null);
                    const alignedRsi = masterTimeStrings.map(ts => rsiMap.get(ts) || null);

                    // 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö)
                    const latest = data[data.length - 1];
                    const latestShort = smaShortSeries[smaShortSeries.length - 1];
                    const latestLong = smaLongSeries[smaLongSeries.length - 1];
                    const latestRSI = rsiSeries[rsiSeries.length - 1];
                    const latestVolatility = volSeries[volSeries.length - 1];

                    // 3. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö)
                    // (NEW) ‡∏™‡πà‡∏á 'dates' ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì
                    const { status, signal, color, isBuySignal, isSellSignal, latestSignalDate } = this.determineSignal(smaShortSeries, smaLongSeries, dates);

                    // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Backtest (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö)
                    const backtest = this.calculateBacktest(data, smaShortSeries, smaLongSeries);
                    
                    // 5. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Risk-Adjusted Score
                    let riskAdjustedScore = 0;
                    if (latestVolatility > 0) {
                        riskAdjustedScore = latestRSI / latestVolatility;
                    }

                    // 6. ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                    this.state.analysisResults.push({
                        name: fundName,
                        latest: {
                            nav: latest.nav,
                            shortMA: latestShort,
                            longMA: latestLong,
                            rsi: latestRSI,
                            volatility: latestVolatility
                        },
                        signal: { status, signal, color, isBuySignal, isSellSignal, latestSignalDate }, // (NEW) ‡πÄ‡∏û‡∏¥‡πà‡∏° latestSignalDate
                        series: { // (NEW) ‡πÉ‡∏ä‡πâ Series ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß
                            prices: alignedPrices,
                            smaShortSeries: alignedSmaShort,
                            smaLongSeries: alignedSmaLong,
                            rsiSeries: alignedRsi 
                        },
                        backtest: backtest,
                        riskAdjustedScore: riskAdjustedScore
                    });
                });
                
                // (End) Sort ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"
                this.state.analysisResults.sort((a, b) => b.riskAdjustedScore - a.riskAdjustedScore);
            },
            
            // === 8. RENDERING (Refactored) ===
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Render ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            renderAll() {
                this.renderDashboard();
                this.renderChart();
                this.renderBacktest(); // <-- Updated
                this.renderSuggestion(); // <-- Updated
            },

            // 8.1 Render Dashboard
            renderDashboard() {
                this.elements.dashboardCardsDiv.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå
                const { settings } = this.state;
                
                this.state.analysisResults.forEach(result => {
                    const { name, latest, signal } = result;
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≠‡∏Å)
                    if (isNaN(latest.nav)) return; 

                    const card = document.createElement('div');
                    card.className = `bg-white p-6 rounded-lg shadow-md border-l-4 border-${signal.color}-500`;
                    card.innerHTML = `
                        <h3 class="text-xl font-bold text-${signal.color}-600">${name}</h3>
                        <p class="text-2xl font-semibold my-2">${signal.status}</p>
                        <p class="text-gray-600 mb-3">${signal.signal}</p>
                        <!-- (NEW) ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
                        ${signal.latestSignalDate ? `<p class="text-sm text-gray-500 mb-3">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${signal.latestSignalDate}</p>` : ''}
                        <div class="text-sm space-y-1 text-gray-700">
                            <p><strong>NAV ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${latest.nav.toFixed(4)}</p>
                            <p><strong>RSI (${settings.rsiPeriod}):</strong> ${latest.rsi.toFixed(2)} ${latest.rsi > 70 ? '(Overbought)' : latest.rsi < 30 ? '(Oversold)' : ''}</p>
                            <p><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô (${settings.volPeriod} ‡∏ß‡∏±‡∏ô):</strong> ${(latest.volatility * 100).toFixed(2)}%</p>
                            <p><strong>MA ${settings.shortMA}:</strong> ${latest.shortMA.toFixed(4)}</p>
                            <p><strong>MA ${settings.longMA}:</strong> ${latest.longMA.toFixed(4)}</p>
                        </div>
                    `;
                    this.elements.dashboardCardsDiv.appendChild(card);
                });
            },

            // 8.2 Render Chart (REFACTORED for Master Axis)
            renderChart() {
                const { settings } = this.state;
                const datasets = [];
                const colors = ['#3b82f6', '#ef4444', '#10b981', '#f97316', '#8b5cf6', '#d946ef'];

                // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á NAV Datasets ---
                this.state.analysisResults.forEach((result, index) => {
                    const { name, series } = result;
                    const color = colors[index % colors.length];

                    // (NEW) ‡πÉ‡∏ä‡πâ series ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß (aligned data)
                    datasets.push({
                        label: name,
                        data: series.prices, // prices (aligned)
                        borderColor: color, backgroundColor: color + '33', borderWidth: 2, tension: 0.1, pointRadius: 0,
                        spanGaps: false // ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
                    });
                    datasets.push({
                        label: `${name} MA ${settings.shortMA}`,
                        data: series.smaShortSeries, // smaShortSeries (aligned)
                        borderColor: color, borderWidth: 1.5, borderDash: [5, 5], tension: 0.1, pointRadius: 0,
                        spanGaps: false
                    });
                    datasets.push({
                        label: `${name} MA ${settings.longMA}`,
                        data: series.smaLongSeries, // smaLongSeries (aligned)
                        borderColor: color, borderWidth: 2, borderDash: [10, 10], tension: 0.1, pointRadius: 0,
                        spanGaps: false
                    });
                });
                
                // (NEW) ‡πÉ‡∏ä‡πâ Master Time Axis
                const labels = this.state.masterTimeAxis; 
                
                if (this.charts.navChart) this.charts.navChart.destroy();
                this.charts.navChart = new Chart(this.elements.navChartCanvas.getContext('2d'), {
                    type: 'line',
                    data: { labels: labels, datasets: datasets },
                    options: { 
                        responsive: true, 
                        plugins: { legend: { position: 'top' }, title: { display: true, text: 'NAV and Moving Averages' } }, 
                        scales: { 
                            y: { beginAtZero: false },
                            x: { // (NEW) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏Å‡∏ô X ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
                                type: 'time',
                                time: { unit: 'month', tooltipFormat: 'dd MMM yyyy' },
                                ticks: { autoSkip: true, maxTicksLimit: 15 }
                            }
                        } 
                    }
                });

                // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á RSI Chart (‡πÉ‡∏ä‡πâ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÅ‡∏£‡∏Å) ---
                const rsiBaseFund = this.state.analysisResults[0];
                if (!rsiBaseFund) return;

                if (this.charts.rsiChart) this.charts.rsiChart.destroy();
                this.charts.rsiChart = new Chart(this.elements.rsiChartCanvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels, // (NEW) ‡πÉ‡∏ä‡πâ Master Time Axis
                        datasets: [
                            { label: `RSI (${settings.rsiPeriod}) - ${rsiBaseFund.name}`, data: rsiBaseFund.series.rsiSeries, borderColor: '#8b5cf6', borderWidth: 2, pointRadius: 0, tension: 0.1, spanGaps: false },
                            { label: 'Overbought (70)', data: Array(labels.length).fill(70), borderColor: '#ef4444', borderWidth: 1.5, borderDash: [5, 5], pointRadius: 0 },
                            { label: 'Oversold (30)', data: Array(labels.length).fill(30), borderColor: '#10b981', borderWidth: 1.5, borderDash: [5, 5], pointRadius: 0 }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { legend: { position: 'top' }, title: { display: true, text: 'Relative Strength Index (RSI)' } }, 
                        scales: { 
                            y: { min: 0, max: 100 },
                            x: { // (NEW) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏Å‡∏ô X ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
                                type: 'time',
                                time: { unit: 'month', tooltipFormat: 'dd MMM yyyy' },
                                ticks: { autoSkip: true, maxTicksLimit: 15 }
                            }
                        } 
                    }
                });
            },

            // 8.3 Render Backtest (REFACTORED for Date Lists)
            renderBacktest() {
                this.elements.backtestResultsDiv.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå
                const { switchLimit } = this.state.settings;

                this.state.analysisResults.forEach(result => {
                    const { name, backtest } = result;
                    if (Object.keys(backtest).length === 0) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

                    const div = document.createElement('div');
                    div.className = 'p-4 bg-gray-50 rounded-lg border';
                    let html = `<h4 class="font-semibold text-lg text-blue-700">${name}</h4>`;
                    
                    const years = Object.keys(backtest).sort((a,b) => b - a); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏õ‡∏µ (‡πÉ‡∏´‡∏°‡πà -> ‡πÄ‡∏Å‡πà‡∏≤)

                    years.forEach(year => {
                        const stats = backtest[year];
                        const total = stats.total;
                        const color = total > switchLimit ? 'text-red-500 font-bold' : 'text-green-600';
                        
                        // (NEW) ‡∏™‡∏£‡πâ‡∏≤‡∏á list ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                        const goldenDatesHtml = stats.golden.length > 0 
                            ? `<ul>${stats.golden.map(date => `<li class="text-green-600">${date}</li>`).join('')}</ul>`
                            : '<p class="text-gray-400 text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ</p>';
                            
                        const deathDatesHtml = stats.death.length > 0
                            ? `<ul>${stats.death.map(date => `<li class="text-red-600">${date}</li>`).join('')}</ul>`
                            : '<p class="text-gray-400 text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ</p>';

                        html += `
                            <div class="mt-2 p-2 border-t">
                                <p><strong>‡∏õ‡∏µ ${year}:</strong> <span class="${color}">‡∏£‡∏ß‡∏° ${total}</span> / ${switchLimit} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></p>
                                <div class="grid grid-cols-2 gap-4 mt-2 text-sm">
                                    <div>
                                        <p class="font-semibold">Golden Cross (${stats.golden.length}):</p>
                                        ${goldenDatesHtml}
                                    </div>
                                    <div>
                                        <p class="font-semibold">Death Cross (${stats.death.length}):</p>
                                        ${deathDatesHtml}
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    div.innerHTML += html;
                    this.elements.backtestResultsDiv.appendChild(div);
                });
            },

            // 8.4 Render Suggestion (REFACTORED for Date info)
            renderSuggestion() {
                this.elements.suggestionResultsDiv.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå
                const { heldFundName, entryDateStr } = this.state.settings;
                const { analysisResults, fundsData } = this.state;

                if (!heldFundName) {
                    this.elements.suggestionResultsDiv.innerHTML = '<p class="text-gray-500">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà" ‡πÉ‡∏ô Sidebar (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"</p>';
                    return;
                }

                const heldFundResult = analysisResults.find(f => f.name === heldFundName);
                if (!heldFundResult) {
                    this.elements.suggestionResultsDiv.innerHTML = `<p class="text-red-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô '${heldFundName}' (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠)</p>`;
                    return;
                }

                // --- 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì P/L ---
                let plSection = '';
                if (entryDateStr) {
                    const entryDate = this.parseDate(entryDateStr, true); // Parse YYYY-MM-DD
                    const fundData = fundsData[heldFundName];
                    const { date: actualDate, nav: entryNav } = this.findNavOnDate(fundData, entryDate);
                    const latestNav = heldFundResult.latest.nav;
                    
                    if (entryNav) {
                        const plPercent = ((latestNav - entryNav) / entryNav) * 100;
                        const plColor = plPercent >= 0 ? 'text-green-600' : 'text-red-600';

                        plSection = `
                            <h4 class="text-lg font-semibold">‡∏™‡∏£‡∏∏‡∏õ‡∏û‡∏≠‡∏£‡πå‡∏ï: ${heldFundName}</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><p class="text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)</p><p class="font-semibold">${actualDate.toLocaleDateString('th-TH')}</p></div>
                                <div><p class="text-gray-500">NAV ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤</p><p class="font-semibold">${entryNav.toFixed(4)}</p></div>
                                <div><p class="text-gray-500">NAV ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p><p class="font-semibold">${latestNav.toFixed(4)}</p></div>
                                <div><p class="text-gray-500">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</p><p class="font-bold text-xl ${plColor}">${plPercent.toFixed(2)}%</p></div>
                            </div><hr class="my-4">`;
                    }
                }

                // --- 2. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß) ---
                const buySignalFunds = analysisResults.filter(f => f.name !== heldFundName && f.signal.isBuySignal);
                let suggestionHTML = '';

                if (heldFundResult.signal.isBuySignal) {
                    suggestionHTML = `
                        <div class="p-4 rounded-lg bg-green-50 border border-green-200">
                            <h4 class="text-xl font-bold text-green-700">‚úÖ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ñ‡∏∑‡∏≠‡∏ï‡πà‡∏≠ (Hold)</h4>
                            <p class="mt-2 text-gray-700">
                                ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô <strong>${heldFundName}</strong> ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô <strong>${heldFundResult.signal.status}</strong>
                                <!-- (NEW) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì -->
                                ${heldFundResult.signal.latestSignalDate ? `(‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${heldFundResult.signal.latestSignalDate})` : ''}
                            </p>
                        </div>
                    `;
                } else if (heldFundResult.signal.isSellSignal) {
                    if (buySignalFunds.length > 0) {
                        // (buySignalFunds ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô performFullAnalysis)
                        const bestFund = buySignalFunds[0];
                        suggestionHTML = `
                            <div class="p-4 rounded-lg bg-yellow-50 border border-yellow-300">
                                <h4 class="text-xl font-bold text-yellow-700">‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏™‡∏•‡∏±‡∏ö (Switch)</h4>
                                <p class="mt-2 text-gray-700">
                                    ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô <strong>${heldFundName}</strong> ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <strong>${heldFundResult.signal.status}</strong>
                                    <!-- (NEW) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì -->
                                    ${heldFundResult.signal.latestSignalDate ? `(‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${heldFundResult.signal.latestSignalDate})` : ''}
                                </p>
                                <div class="mt-4 p-3 bg-green-100 rounded-lg border border-green-300">
                                    <p class="font-semibold text-green-800">‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á):</p>
                                    <p class="text-xl font-bold text-green-700">${bestFund.name}</p>
                                    <!-- (NEW) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì -->
                                    <span class="text-sm text-gray-700">
                                        (${bestFund.signal.status} | ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${bestFund.signal.latestSignalDate || 'N/A'})
                                    </span>
                                </div>
                                ${
                                    buySignalFunds.length > 1 ? `
                                    <p class="mt-4 text-gray-700">‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á):</p>
                                    <ul class="list-disc list-inside mt-2 space-y-1 text-sm">
                                        ${buySignalFunds.slice(1).map(f => `<li class="text-gray-600">${f.name} (‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${f.signal.latestSignalDate || 'N/A'})</li>`).join('')}
                                    </ul>` : ''
                                }
                            </div>
                        `;
                    } else {
                        // (‡∏ï‡∏£‡∏£‡∏Å‡∏∞ Risk-Off)
                        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏à‡∏≤‡∏Å "‡∏ó‡∏∏‡∏Å‡∏Å‡∏≠‡∏á" ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤ (‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏Ñ‡πà‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
                        const safeFundNames = ["‡∏ï‡∏£‡∏≤‡∏™‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å", "‡πÅ‡∏ú‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏á‡∏¥‡∏ô"];
                        const allSafeFunds = [];
                        
                        safeFundNames.forEach(safeName => {
                             const safeFundData = this.state.fundsData[safeName];
                             if (safeFundData) {
                                 // ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÉ‡∏´‡πâ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)
                                 let safeFundResult = analysisResults.find(f => f.name === safeName);
                                 if (!safeFundResult) {
                                     // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠
                                     const prices = safeFundData.map(d => d.nav);
                                     const dates = safeFundData.map(d => d.date);
                                     const smaShort = this.calculateMA(prices, settings.shortMA);
                                     const smaLong = this.calculateMA(prices, settings.longMA);
                                     const { isSellSignal } = this.determineSignal(smaShort, smaLong, dates);
                                     if (!isSellSignal) {
                                         allSafeFunds.push({ name: safeName, signal: { isSellSignal: false } });
                                     }
                                 } else if (!safeFundResult.signal.isSellSignal) {
                                     allSafeFunds.push(safeFundResult);
                                 }
                             }
                        });
                        
                        if (allSafeFunds.length > 0) {
                            const bestSafeFund = allSafeFunds[0]; // (‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠)
                            suggestionHTML = `
                                <div class="p-4 rounded-lg bg-blue-50 border border-blue-200">
                                    <h4 class="text-xl font-bold text-blue-700">üõ°Ô∏è ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Risk-Off)</h4>
                                    <p class="mt-2 text-gray-700">
                                        ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô <strong>${heldFundName}</strong> ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô <strong>${heldFundResult.signal.status}</strong> ‡πÅ‡∏•‡∏∞‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏∑‡πà‡∏ô (‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡∏™‡∏†‡∏≤‡∏ß‡∏∞ Risk-Off)
                                    </p>
                                    <div class="mt-4 p-3 bg-blue-100 rounded-lg border border-blue-300">
                                        <p class="font-semibold text-blue-800">‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô):</p>
                                        <p class="text-xl font-bold text-blue-700">${bestSafeFund.name}</p>
                                    </div>
                                </div>
                            `;
                        } else {
                            suggestionHTML = `
                                <div class="p-4 rounded-lg bg-red-50 border border-red-200">
                                    <h4 class="text-xl font-bold text-red-700">üö® ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ç‡∏≤‡∏¢/‡∏£‡∏≠ (Wait)</h4>
                                     <p class="mt-2 text-gray-700">
                                        ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô <strong>${heldFundName}</strong> ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô <strong>${heldFundResult.signal.status}</strong> ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢) ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                                    </p>
                                    <p class="mt-2 text-gray-700">‡∏≠‡∏≤‡∏à‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ñ‡∏∑‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</p>
                                </div>
                            `;
                        }
                    }
                } else {
                    // (Sideways)
                    suggestionHTML = `
                        <div class="p-4 rounded-lg bg-gray-100 border border-gray-200">
                            <h4 class="text-xl font-bold text-gray-700">‚öñÔ∏è ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏£‡∏≠‡∏î‡∏π‡∏ó‡πà‡∏≤‡∏ó‡∏µ (Sideways)</h4>
                            <p class="mt-2 text-gray-700">
                                ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô <strong>${heldFundName}</strong> ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <strong>${heldFundResult.signal.status}</strong> (‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)
                                ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏î‡∏π‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì Golden/Death Cross ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à
                            </p>
                        </div>
                    `;
                }

                this.elements.suggestionResultsDiv.innerHTML = plSection + suggestionHTML;
            },

            // === 9. UI HELPERS ===
            
            populateFundSelector() {
                this.elements.fundSelectorDiv.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå
                this.elements.currentFundSelect.innerHTML = '<option value="">-- ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>'; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå

                const fundNames = Object.keys(this.state.fundsData).sort();

                if (fundNames.length === 0) {
                    this.elements.fundSelectorDiv.innerHTML = '<p class="text-sm text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</p>';
                    return;
                }

                fundNames.forEach((fundName, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    div.innerHTML = `
                        <input type="checkbox" id="fund-${index}" value="${fundName}" class="fund-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
                        <label for="fund-${index}" class="ml-2 block text-sm text-gray-700">${fundName}</label>
                    `;
                    this.elements.fundSelectorDiv.appendChild(div);

                    const option = document.createElement('option');
                    option.value = fundName;
                    option.textContent = fundName;
                    this.elements.currentFundSelect.appendChild(option);
                });
            },

            setStatus(message, color) {
                if (!this.elements.statusMessage) return; // Guard clause
                this.elements.statusMessage.textContent = message;
                if (color === 'green') {
                    this.elements.statusMessage.className = 'mt-4 text-sm text-green-600';
                } else if (color === 'red') {
                    this.elements.statusMessage.className = 'mt-4 text-sm text-red-600';
                } else {
                    this.elements.statusMessage.className = 'mt-4 text-sm text-blue-600';
                }
            },

            // === 10. CALCULATION HELPERS ===

            parseDate(dateStr, isISO = false) {
                if (isISO && dateStr) {
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö YYYY-MM-DD (‡∏à‡∏≤‡∏Å input type="date")
                    return new Date(dateStr);
                }
                
                if (typeof dateStr !== 'string' || !dateStr.includes('/')) {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà string ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ /
                    return new Date(dateStr); // ‡∏•‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏£‡∏á‡πÜ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Date object ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß)
                }

                const parts = dateStr.split('/'); // [dd, mm, yyyy]
                if (parts.length === 3) {
                    const day = parts[0];
                    const month = parts[1]; // 01-12
                    let year = parseInt(parts[2]);
                    if (year > 2500) year = year - 543; // ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®.
                    // (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô JS ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0)
                    return new Date(year, parseInt(month) - 1, parseInt(day));
                }
                
                return null; // ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
            },

            findNavOnDate(fundData, targetDate) {
                if (!fundData || fundData.length === 0 || !(targetDate instanceof Date) || isNaN(targetDate)) {
                    return { date: null, nav: null };
                }
                
                // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)
                let closestData = fundData[0];
                let minDiff = Math.abs(targetDate.getTime() - closestData.date.getTime());

                for (let i = 1; i < fundData.length; i++) {
                    const currentDiff = Math.abs(targetDate.getTime() - fundData[i].date.getTime());
                    if (currentDiff < minDiff) {
                        minDiff = currentDiff;
                        closestData = fundData[i];
                    }
                }
                return closestData; // { date: Date, nav: Number }
            },
            
            // (Refactored) ‡πÅ‡∏¢‡∏Å‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à
            // (NEW) ‡πÄ‡∏û‡∏¥‡πà‡∏° `dates` (Array) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            determineSignal(smaShort, smaLong, dates) {
                // ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà NaN
                const getLastValid = (arr) => arr.slice().reverse().find(v => !isNaN(v));
                const getSecondLastValid = (arr) => {
                    const validArr = arr.filter(v => !isNaN(v));
                    return validArr[validArr.length - 2];
                };

                const latestShort = getLastValid(smaShort);
                const latestLong = getLastValid(smaLong);
                const prevShort = getSecondLastValid(smaShort);
                const prevLong = getSecondLastValid(smaLong);

                let status = '‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (Sideways)';
                let signal = '‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì';
                let color = 'gray';
                let isBuySignal = false;
                let isSellSignal = false;
                let latestSignalDate = null; // (NEW)
                
                if (isNaN(latestShort) || isNaN(latestLong) || isNaN(prevShort) || isNaN(prevLong)) {
                    status = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠';
                    return { status, signal, color, isBuySignal, isSellSignal, latestSignalDate };
                }
                
                // (NEW) ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                const startIndex = smaLong.findIndex(v => !isNaN(v));
                if (startIndex > -1) {
                    for (let i = dates.length - 1; i > startIndex; i--) {
                        if (isNaN(smaShort[i]) || isNaN(smaLong[i]) || isNaN(smaShort[i-1]) || isNaN(smaLong[i-1])) continue;
                        
                        const isGolden = smaShort[i-1] <= smaLong[i-1] && smaShort[i] > smaLong[i];
                        const isDeath = smaShort[i-1] >= smaLong[i-1] && smaShort[i] < smaLong[i];
                        
                        if (isGolden || isDeath) {
                            latestSignalDate = dates[i] ? dates[i].toLocaleDateString('th-TH') : null;
                            break; // ‡πÄ‡∏à‡∏≠‡∏≠‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏¢‡∏∏‡∏î
                        }
                    }
                }

                if (latestShort > latestLong && prevShort <= prevLong) {
                    status = 'Golden Cross!';
                    signal = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠ (‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô)';
                    color = 'green';
                    isBuySignal = true;
                } else if (latestShort < latestLong && prevShort >= prevLong) {
                    status = 'Death Cross!';
                    signal = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≤‡∏¢ (‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ç‡∏≤‡∏•‡∏á)';
                    color = 'red';
                    isSellSignal = true;
                } else if (latestShort > latestLong) {
                    status = '‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô';
                    signal = '‡∏ñ‡∏∑‡∏≠ (Above Long MA)';
                    color = 'green';
                    isBuySignal = true;
                } else if (latestShort < latestLong) {
                    status = '‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ç‡∏≤‡∏•‡∏á';
                    signal = '‡∏£‡∏≠ (Below Long MA)';
                    color = 'red';
                    isSellSignal = true;
                }
                
                return { status, signal, color, isBuySignal, isSellSignal, latestSignalDate };
            },
            
            // (Refactored) ‡πÅ‡∏¢‡∏Å‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Backtest
            // (NEW) ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö
            calculateBacktest(data, smaShort, smaLong) {
                let signals = {}; // { 2024: { golden: [Date], death: [Date], total: 2 }, 2025: ... }
                
                // ‡∏´‡∏≤ index ‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà smaLong ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤
                const startIndex = smaLong.findIndex(v => !isNaN(v));
                if (startIndex === -1 || startIndex === 0) return {}; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

                for (let i = startIndex + 1; i < data.length; i++) {
                    const date = data[i].date;
                    const year = date.getFullYear();
                    
                    if (!signals[year]) signals[year] = { golden: [], death: [], total: 0 };

                    const prevShort = smaShort[i-1];
                    const prevLong = smaLong[i-1];
                    const currShort = smaShort[i];
                    const currLong = smaLong[i];

                    if (isNaN(prevShort) || isNaN(prevLong) || isNaN(currShort) || isNaN(currLong)) {
                        continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
                    }

                    const dateString = date.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });

                    if (prevShort <= prevLong && currShort > currLong) { // Golden Cross
                        signals[year].golden.push(dateString); // (NEW)
                        signals[year].total++;
                    } else if (prevShort >= prevLong && currShort < currLong) {  // Death Cross
                        signals[year].death.push(dateString); // (NEW)
                        signals[year].total++;
                    }
                }
                return signals;
            },

            // --- TA Calculations ---
            calculateMA(data, period) {
                let results = [];
                for (let i = 0; i < data.length; i++) {
                    if (i < period - 1) {
                        results.push(NaN);
                    } else {
                        const slice = data.slice(i - (period - 1), i + 1);
                        const sum = slice.reduce((a, b) => a + b, 0);
                        results.push(sum / period);
                    }
                }
                return results;
            },

            calculateRSI(data, period) {
                let gains = [];
                let losses = [];
                let rsi = [];

                for (let i = 1; i < data.length; i++) {
                    const diff = data[i] - data[i-1];
                    gains.push(diff > 0 ? diff : 0);
                    losses.push(diff < 0 ? -diff : 0);
                }

                let avgGain = NaN;
                let avgLoss = NaN;

                for (let i = 0; i < data.length; i++) {
                    if (i < period) {
                        rsi.push(NaN); // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏≠
                    } else if (i === period) {
                        // First calculation
                        avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
                        avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
                    } else {
                        // Smoothing
                        avgGain = ((avgGain * (period - 1)) + gains[i-1]) / period;
                        avgLoss = ((avgLoss * (period - 1)) + losses[i-1]) / period;
                    }
                    
                    if (i >= period) {
                        if (avgLoss === 0) {
                            rsi.push(100);
                        } else {
                            const rs = avgGain / avgLoss;
                            rsi.push(100 - (100 / (1 + rs)));
                        }
                    }
                }
                return rsi;
            },

            calculateVolatility(data, period) {
                let results = [];
                let returns = [];

                for (let i = 1; i < data.length; i++) {
                    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ 0 ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                    if (data[i-1] > 0) {
                        returns.push((data[i] - data[i-1]) / data[i-1]);
                    } else {
                        returns.push(0);
                    }
                }
                
                // (returns ‡∏à‡∏∞‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ data 1 ‡∏ä‡πà‡∏≠‡∏á)
                for (let i = 0; i < returns.length; i++) {
                    if (i < period - 1) {
                        results.push(NaN);
                    } else {
                        const slice = returns.slice(i - (period - 1), i + 1);
                        const mean = slice.reduce((a, b) => a + b, 0) / period;
                        const variance = slice.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / period;
                        results.push(Math.sqrt(variance));
                    }
                }
                results.unshift(NaN); // ‡πÄ‡∏û‡∏¥‡πà‡∏° NaN ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö 'data'
                return results;
            }
        };

        // === START APP ===
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        window.addEventListener('DOMContentLoaded', () => {
            GPFApp.init();
        });

    </script>
</body>
</html>